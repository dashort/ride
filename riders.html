<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Riders</title>
  <style>
    :root {
      color-scheme: light dark;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: #f2f4f8;
      min-height: 100vh;
      color: #1f2933;
    }

    header {
      background: linear-gradient(135deg, #4c6ef5, #364fc7);
      color: #ffffff;
      padding: 1.5rem 2rem;
      box-shadow: 0 2px 12px rgba(15, 23, 42, 0.2);
    }

    header h1 {
      margin: 0;
      font-size: 1.9rem;
      font-weight: 600;
    }

    main {
      max-width: 1100px;
      margin: 2rem auto 3rem;
      padding: 0 1.5rem;
    }

    .panel {
      background: #ffffff;
      border-radius: 14px;
      padding: 1.5rem 1.75rem;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
    }

    .status-message {
      margin: 0;
      padding: 1rem;
      border-radius: 10px;
      background: #edf2ff;
      color: #364fc7;
      text-align: center;
      font-weight: 500;
    }

    .status-message.error {
      background: #ffe3e3;
      color: #c92a2a;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    thead {
      background: #f1f5f9;
    }

    th,
    td {
      padding: 0.75rem 0.9rem;
      text-align: left;
      font-size: 0.95rem;
      border-bottom: 1px solid #e5e9f0;
    }

    tbody tr:hover {
      background: #f8fafc;
    }

    a.action-link {
      color: #3b5bdb;
      text-decoration: none;
      font-weight: 600;
    }

    a.action-link:hover,
    a.action-link:focus {
      text-decoration: underline;
    }

    .calendar-link {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: #e7f5ff;
      color: #1c7ed6;
      padding: 0.4rem 0.75rem;
      border-radius: 999px;
      text-decoration: none;
      font-weight: 600;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .calendar-link:hover,
    .calendar-link:focus {
      background: #d0ebff;
      transform: translateY(-1px);
    }

    @media (max-width: 720px) {
      table,
      thead,
      tbody,
      tr,
      th,
      td {
        display: block;
      }

      thead {
        display: none;
      }

      tr {
        margin-bottom: 1.5rem;
        border: 1px solid #e5e9f0;
        border-radius: 12px;
        padding: 1rem;
        background: #ffffff;
      }

      td {
        border: none;
        padding: 0.4rem 0;
      }

      td::before {
        content: attr(data-label);
        display: block;
        font-weight: 600;
        color: #6c7b94;
        margin-bottom: 0.25rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Rider Directory</h1>
  </header>

  <div id="navigation-container"></div>

  <main>
    <section class="panel">
      <p id="status" class="status-message">Loading ridersâ€¦</p>
      <table id="rider-table" hidden>
        <thead>
          <tr>
            <th scope="col">Rider ID</th>
            <th scope="col">Name</th>
            <th scope="col">Status</th>
            <th scope="col">Availability</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script>
    (function () {
      const state = {
        baseUrl: ''
      };

      const statusEl = document.getElementById('status');
      const tableEl = document.getElementById('rider-table');
      const tbodyEl = tableEl.querySelector('tbody');

      function setStatus(message, isError) {
        statusEl.textContent = message;
        statusEl.classList.toggle('error', Boolean(isError));
        statusEl.hidden = false;
      }

      function hideStatus() {
        statusEl.hidden = true;
      }

      function buildPageUrl(page, params) {
        const safeParams = params || {};

        if (!state.baseUrl) {
          const search = new URLSearchParams(safeParams);
          const path = `${page}.html`;
          return search.toString() ? `${path}?${search.toString()}` : path;
        }

        try {
          const url = new URL(state.baseUrl);
          url.searchParams.set('page', page);
          Object.keys(safeParams).forEach((key) => {
            if (safeParams[key] !== undefined && safeParams[key] !== null) {
              url.searchParams.set(key, safeParams[key]);
            }
          });
          return url.toString();
        } catch (error) {
          console.error('Failed to construct page URL, falling back to relative path.', error);
          const search = new URLSearchParams(safeParams);
          const path = `${page}.html`;
          return search.toString() ? `${path}?${search.toString()}` : path;
        }
      }

      function createCell(label, content) {
        const td = document.createElement('td');
        td.dataset.label = label;
        if (content instanceof Node) {
          td.appendChild(content);
        } else {
          td.textContent = content;
        }
        return td;
      }

      function createCalendarLink(riderId) {
        const link = document.createElement('a');
        link.className = 'calendar-link';
        link.href = buildPageUrl('rider-availability', { riderId });
        link.target = '_blank';
        link.rel = 'noopener';
        link.textContent = 'View Calendar';
        return link;
      }

      function createEditLink(riderId, name) {
        const link = document.createElement('a');
        link.className = 'action-link';
        link.href = buildPageUrl('edit-rider', { riderId });
        link.target = '_top';
        link.textContent = name || 'Edit Rider';
        return link;
      }

      function renderRiders(response) {
        if (!response || !response.success) {
          const message = (response && response.message) ? response.message : 'Unable to load riders.';
          setStatus(message, true);
          tableEl.hidden = true;
          return;
        }

        const riders = Array.isArray(response.riders) ? response.riders : [];

        if (riders.length === 0) {
          setStatus('No riders available.', false);
          tableEl.hidden = true;
          return;
        }

        tbodyEl.innerHTML = '';

        riders.forEach((rider) => {
          const riderId = rider.riderId || '';
          const name = rider.name || 'Unnamed Rider';
          const status = rider.status || 'Unknown';

          const row = document.createElement('tr');
          row.appendChild(createCell('Rider ID', riderId));
          row.appendChild(createCell('Name', createEditLink(riderId, name)));
          row.appendChild(createCell('Status', status));
          row.appendChild(createCell('Availability', createCalendarLink(riderId)));
          tbodyEl.appendChild(row);
        });

        tableEl.hidden = false;
        hideStatus();
      }

      function requestRiders() {
        if (window.google && google.script && google.script.run) {
          google.script.run
            .withSuccessHandler(renderRiders)
            .withFailureHandler((error) => {
              console.error('Failed to retrieve riders:', error);
              setStatus('Failed to retrieve riders.', true);
            })
            .getRidersForPage();
        } else {
          setStatus('Google Apps Script runtime unavailable.', true);
        }
      }

      function initialize() {
        if (window.google && google.script && google.script.run) {
          google.script.run
            .withSuccessHandler((url) => {
              state.baseUrl = url || '';
              requestRiders();
            })
            .withFailureHandler((error) => {
              console.warn('Could not determine base URL:', error);
              state.baseUrl = '';
              requestRiders();
            })
            .getWebAppUrl();
        } else {
          setStatus('Google Apps Script runtime unavailable.', true);
        }
      }

      document.addEventListener('DOMContentLoaded', initialize);
    })();
  </script>
  <script src="load-navigation.js"></script>
</body>
</html>
