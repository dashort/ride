<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riders - Motorcycle Escort Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logout-btn {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .logout-btn:hover {
            text-decoration: underline;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .navigation {
            display: flex !important;
            gap: 1rem !important;
            margin: 1rem auto 2rem auto !important;
            max-width: 1400px !important;
            padding: 0 2rem !important;
            flex-wrap: wrap !important;
            justify-content: center !important;
            position: relative !important;
            z-index: 10 !important;
        }

        .nav-button {
            padding: 0.75rem 1.5rem !important;
            background: rgba(255, 255, 255, 0.9) !important;
            border: none !important;
            border-radius: 25px !important;
            color: #2c3e50 !important;
            text-decoration: none !important;
            font-weight: 600 !important;
            transition: all 0.3s ease !important;
            cursor: pointer !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        .nav-button:hover, .nav-button.active {
            background: #3498db !important;
            color: white !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3) !important;
        }

        .riders-header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .page-title {
            font-size: 2rem;
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #3498db;
        }

        .stat-card.success {
            border-left-color: #27ae60;
        }

        .stat-card.warning {
            border-left-color: #f39c12;
        }

        .stat-card.danger {
            border-left-color: #e74c3c;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
            display: block;
        }

        .stat-card.success .stat-number {
            color: #27ae60;
        }

        .stat-card.warning .stat-number {
            color: #f39c12;
        }

        .stat-card.danger .stat-number {
            color: #e74c3c;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .rider-controls {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #229954);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-info {
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .search-filter-section {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .filter-select {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 25px;
            background: white;
            font-size: 1rem;
            outline: none;
        }

        .riders-table-container {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .riders-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        .riders-table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #ecf0f1;
        }

        .riders-table td {
            padding: 1rem;
            border-bottom: 1px solid #ecf0f1;
            vertical-align: middle;
        }
        .rider-name-cell, .rider-phone-cell {
            white-space: nowrap;
        }

        .riders-table tr:hover {
            background: rgba(52, 152, 219, 0.05);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active { background: #d4edda; color: #155724; }
        .status-inactive { background: #f8d7da; color: #721c24; }
        .status-vacation { background: #fff3cd; color: #856404; }
        .status-training { background: #cce5ff; color: #004085; }
        .status-suspended { background: #e2e3e5; color: #6c757d; }

        .actions-cell {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 15px;
            width: 95%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            padding: 1.5rem;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            margin: 0;
            font-size: 1.3rem;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 2rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
            outline: none;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #ecf0f1;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #7f8c8d;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #7f8c8d;
        }

        .bulk-actions {
            background: #e8f5e8;
            border: 1px solid #27ae60;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
        }

        .bulk-actions.show {
            display: block;
        }

        .checkbox-column {
            width: 40px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .riders-header {
                padding: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .rider-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-filter-section {
                flex-direction: column;
            }

            .riders-table-container {
                padding: 1rem;
            }

            .actions-cell {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>üèçÔ∏è Motorcycle Escort Management</h1>
        
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">?</div>
            <div>
                <div id="userName">Loading...</div>
                <div id="userRole">User</div>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </header>

    <!--NAVIGATION_MENU_PLACEHOLDER-->

    <div class="container">
        <div class="riders-header">
            <h2 class="page-title">üë• Rider Management</h2>
            
            <!-- Statistics Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="totalRiders">-</span>
                    <div class="stat-label">Total Riders</div>
                </div>
                <div class="stat-card success">
                    <span class="stat-number" id="activeRiders">-</span>
                    <div class="stat-label">Active</div>
                </div>
                <div class="stat-card warning">
                    <span class="stat-number" id="inactiveRiders">-</span>
                    <div class="stat-label">Inactive</div>
                </div>
                <div class="stat-card warning">
                    <span class="stat-number" id="partTimeRiders">-</span>
                    <div class="stat-label">Part Time Riders</div>
                </div>
                <div class="stat-card danger">
                    <span class="stat-number" id="fullTimeRiders">-</span>
                    <div class="stat-label">Full time Riders</div>
                </div>
            </div>
        </div>

        <!-- Rider Controls -->
        <div class="rider-controls">
            <button onclick="openAddRiderModal()" class="btn btn-success">
                ‚ûï Add New Rider
            </button>
            
            <div class="search-filter-section">
                <input type="text" class="search-box" placeholder="üîç Search riders..." id="searchBox" onkeyup="filterRiders()">
                
                <select class="filter-select" id="statusFilter" onchange="filterRiders()">
                    <option value="All">All Statuses</option>
                    <option value="Active">Active</option>
                    <option value="Inactive">Inactive</option>
                    <option value="Vacation">On Vacation</option>
                    <option value="Training">In Training</option>
                    <option value="Suspended">Suspended</option>
                </select>
                <select class="filter-select" id="motorFilter" onchange="filterRiders()">
                    <option value="Motors" selected>Motors</option>
                    <option value="All">All</option>
                </select>
            </div>
            
            <button onclick="exportRiders()" class="btn btn-info">
                üìä Export CSV
            </button>
            
            <button onclick="toggleBulkMode()" class="btn btn-warning" id="bulkModeBtn">
                üìã Bulk Actions
            </button>
        </div>

        <!-- Bulk Actions Panel -->
        <div class="bulk-actions" id="bulkActionsPanel">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>Selected: <span id="selectedCount">0</span> riders</span>
                <div>
                    <select id="bulkStatusSelect" class="filter-select">
                        <option value="">Select Status</option>
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                        <option value="Vacation">On Vacation</option>
                        <option value="Training">In Training</option>
                        <option value="Suspended">Suspended</option>
                    </select>
                    <button onclick="applyBulkStatusUpdate()" class="btn btn-primary">Update Status</button>
                    <button onclick="clearSelection()" class="btn btn-danger">Clear Selection</button>
                </div>
            </div>
        </div>

        <!-- Riders Table -->
        <div class="riders-table-container">
            <div id="loadingDiv" class="loading">
                üîÑ Loading riders...
            </div>
            
            <div id="tableDiv" style="display: none;">
                <table class="riders-table">
                    <thead>
                        <tr>
                            <th class="checkbox-column">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                            </th>
                            <th>Rider ID</th>
                            <th>Payroll Number</th>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Platoon</th>
                            <th>Part Time</th>
                            <th>Certification</th>
                            <th>Organization</th>
                            <th>Assignments</th>
                            <th>Last Assignment</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ridersTableBody">
                    </tbody>
                </table>
            </div>
            
            <div id="emptyStateDiv" class="empty-state" style="display: none;">
                <h3>No riders found</h3>
                <p>Try adjusting your search or filter criteria</p>
            </div>
        </div>
    </div>

    <!-- Rider Modal -->
    <div id="riderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add New Rider</h3>
                <span class="close" onclick="closeRiderModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="riderForm">
                    <input type="hidden" id="originalRiderId" name="originalRiderId">
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="riderId">Rider ID *</label>
                            <input type="text" id="riderId" name="riderId" required>
                        </div>

                        <div class="form-group">
                            <label for="riderPayroll">Payroll Number</label>
                            <input type="text" id="riderPayroll" name="riderPayroll" pattern="\d{5,8}" title="5-8 digits">
                        </div>
                        
                        <div class="form-group">
                            <label for="riderName">Full Name *</label>
                            <input type="text" id="riderName" name="riderName" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="riderPhone">Phone Number *</label>
                            <input type="tel" id="riderPhone" name="riderPhone" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="riderEmail">Email</label>
                            <input type="email" id="riderEmail" name="riderEmail">
                        </div>
                        
                        <div class="form-group">
                            <label for="riderStatus">Status</label>
                            <select id="riderStatus" name="riderStatus">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                                <option value="Vacation">On Vacation</option>
                                <option value="Training">In Training</option>
                                <option value="Suspended">Suspended</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="riderPlatoon">Platoon</label>
                            <select id="riderPlatoon" name="riderPlatoon">
                                <option value=""></option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="riderPartTime">Part Time Rider</label>
                            <select id="riderPartTime" name="riderPartTime">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="riderCertification">Certification</label>
                            <select id="riderCertification" name="riderCertification">
                                <option value="Standard">Standard</option>
                                <option value="Advanced">Advanced</option>
                                <option value="Instructor">Instructor</option>
                                <option value="Trainee">Trainee</option>
                                <option value="Not Certified">Not Certified</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="riderOrganization">Organization</label>
                            <select id="riderOrganization" name="riderOrganization">
                                <option value="">Internal (Default)</option>
                                <option value="NOPD">NOPD</option>
                                <option value="Other">Other Organization</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeRiderModal()">Cancel</button>
                <button type="button" class="btn btn-danger" id="deleteRiderBtn" onclick="deleteCurrentRider()" style="display:none">üóëÔ∏è Delete</button>
                <button type="button" class="btn btn-success" onclick="saveRider()">üíæ Save Rider</button>
            </div>
        </div>
    </div>

<script>
    // Global state
    let app = {
        user: null,
        riders: [],
        filteredRiders: [],
        selectedRiders: new Set(),
        bulkMode: false,
        isOnline: navigator.onLine
    };

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ Riders page loading...');
        addScheduleLinks();

        const params = new URLSearchParams(window.location.search);
        const statusParam = params.get('status');
        if (statusParam) {
            const statusFilter = document.getElementById('statusFilter');
            if (statusFilter) {
                statusFilter.value = statusParam;
            }
        }

        loadRidersData();
        setupEventListeners();
        
        // Add diagnostic button for debugging
        addDiagnosticButton();

        // Fetch the web app URL when running inside Apps Script
        if (typeof google !== 'undefined' && google.script && google.script.run) {
            try {
                google.script.run
                    .withSuccessHandler(url => { window.ridersBaseUrl = url; })
                    .withFailureHandler(() => { window.ridersBaseUrl = null; })
                    .getWebAppUrl();
            } catch (e) {
                window.ridersBaseUrl = null;
            }
        }
    });

/**
 * IMPROVED: Better event listener setup
 * Replace the setupEventListeners function in riders.html
 */

    function loadRidersData() {
        console.log('üîÑ loadRidersData() called');
        showLoading();
        
        if (typeof google !== 'undefined' && google.script && google.script.run) {
            console.log('‚úÖ Google Apps Script available, calling getPageDataForRiders...');
            
            // Add timeout protection
            let timeoutId = setTimeout(() => {
                console.error('‚è∞ Request timed out after 30 seconds');
                handleRidersDataFailure({ message: "Request timed out. This may indicate a backend issue." });
            }, 30000);
            
            google.script.run
                .withSuccessHandler(function(data) {
                    clearTimeout(timeoutId);
                    console.log('üì• Raw data received from backend:', data);
                    
                    // Additional validation
                    if (!data) {
                        console.error('‚ùå Received null/undefined data from backend');
                        // Attempt fallbacks before showing an error
                        tryFallbackDataLoading(new Error('No data received from server'));
                        return;
                    }
                    
                    handleRidersDataSuccess(data);
                })
                .withFailureHandler(function(error) {
                    clearTimeout(timeoutId);
                    console.error('üì• Error received from backend:', error);
                    
                    // Try alternative approaches
                    console.log('üîÑ Attempting fallback methods...');
                    tryFallbackDataLoading(error);
                })
                .getPageDataForRiders();
        } else {
            console.log('‚ö†Ô∏è Google Apps Script not available');
            handleRidersDataFailure({ message: "Google Apps Script not available." });
        }
    }

    // Fallback data loading methods
    function tryFallbackDataLoading(originalError) {
        console.log('üö® Trying fallback data loading methods...');
        
        // Fallback 1: Try test function
        if (typeof google !== 'undefined' && google.script && google.script.run) {
            console.log('üîÑ Fallback 1: Trying test function...');
            
            google.script.run
                .withSuccessHandler(function(data) {
                    if (data && data.success) {
                        console.log('‚úÖ Fallback 1 succeeded');
                        handleRidersDataSuccess(data);
                    } else {
                        console.log('‚ùå Fallback 1 failed, trying fallback 2...');
                        tryEmergencyData(originalError);
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('‚ùå Fallback 1 failed:', error);
                    tryEmergencyData(originalError);
                })
                .testRidersLoadingFix();
        } else {
            tryEmergencyData(originalError);
        }
    }

    // Emergency fallback with sample data
    function tryEmergencyData(originalError) {
        console.log('üö® Using emergency fallback data...');
        
        const emergencyData = {
            success: true,
            user: {
                name: 'Emergency User',
                email: 'emergency@nopd.com',
                roles: ['admin']
            },
            riders: [],
            stats: {
                totalRiders: 0,
                activeRiders: 0,
                inactiveRiders: 0,
                partTimeRiders: 0,
                fullTimeRiders: 0
            },
            debug: {
                method: 'emergency_fallback',
                originalError: originalError.message || originalError
            }
        };
        
        console.log('‚ö†Ô∏è Showing emergency state with error message');
        handleRidersDataSuccess(emergencyData);
        
        // Show error notification
        showError(`Failed to load riders data: ${originalError.message || originalError}. Please check the backend configuration.`);
    }

    // DIAGNOSTIC FUNCTIONS - FOR DEBUGGING
    function diagnoseFrontendIssue() {
        console.log('\nüîç === FRONTEND DIAGNOSTIC START ===');
        
        // Check Google Apps Script availability
        console.log('1. Google Apps Script Check:');
        if (typeof google !== 'undefined' && google.script && google.script.run) {
            console.log('‚úÖ Google Apps Script is available');
            
            // Test backend connectivity
            console.log('\n2. Testing backend connectivity...');
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('‚úÖ Backend connectivity test passed');
                    console.log('Backend test result:', result);
                    
                    // Run comprehensive fix
                    console.log('\n3. Running comprehensive fix...');
                    google.script.run
                        .withSuccessHandler(function(fixResult) {
                            console.log('üéâ Comprehensive fix completed:');
                            console.log(fixResult);
                            
                            if (fixResult.success) {
                                console.log('‚úÖ All backend checks passed');
                                console.log('üîÑ Retrying rider data load...');
                                loadRidersData();
                            } else {
                                console.log('‚ùå Backend issues found:');
                                fixResult.steps.forEach(step => {
                                    console.log(`${step.success ? '‚úÖ' : '‚ùå'} ${step.name}: ${step.message || step.error}`);
                                });
                            }
                        })
                        .withFailureHandler(function(error) {
                            console.error('‚ùå Comprehensive fix failed:', error);
                        })
                        .fixRidersLoadingIssue();
                })
                .withFailureHandler(function(error) {
                    console.error('‚ùå Backend connectivity test failed:', error);
                })
                .quickRidersTest();
        } else {
            console.log('‚ùå Google Apps Script not available');
            console.log('   - Check if page is running in Google Apps Script environment');
            console.log('   - Check browser console for JavaScript errors');
        }
        
        // Check page state
        console.log('\n4. Page State Check:');
        console.log(`   - app object exists: ${typeof app !== 'undefined'}`);
        console.log(`   - app.riders: ${app && app.riders ? `Array(${app.riders.length})` : 'null/undefined'}`);
        console.log(`   - app.user: ${app && app.user ? 'present' : 'null/undefined'}`);
        
        // Check DOM elements
        console.log('\n5. DOM Elements Check:');
        const elements = ['searchBox', 'statusFilter', 'ridersTable', 'totalRiders'];
        elements.forEach(id => {
            const element = document.getElementById(id);
            console.log(`   - ${id}: ${element ? 'found' : 'missing'}`);
        });
        
        console.log('\nüîç === FRONTEND DIAGNOSTIC END ===\n');
    }

    // Add diagnostic button to page (for debugging)
    function addDiagnosticButton() {
        const button = document.createElement('button');
        button.textContent = 'üîç Diagnose Issue';
        button.style.cssText = `
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        `;
        button.onclick = diagnoseFrontendIssue;
        document.body.appendChild(button);
    }

    function handleRidersDataFailure(error) {
        hideLoading();
        console.error('‚ùå Error loading riders:', error);
        showError('Error loading riders: ' + (error.message || error));
    }

    function updateUserInfo(user) {
        document.getElementById('userName').textContent = user.name || 'User';
        document.getElementById('userRole').textContent = (user.roles || ['user']).join(', ');
        document.getElementById('userAvatar').textContent = (user.name || 'U').charAt(0).toUpperCase();
    }

    function updateStats(stats) {
        document.getElementById('totalRiders').textContent = stats.totalRiders || 0;
        document.getElementById('activeRiders').textContent = stats.activeRiders || 0;
        document.getElementById('inactiveRiders').textContent = stats.inactiveRiders || 0;

        document.getElementById('partTimeRiders').textContent = stats.partTimeRiders || 0;

        const fullTimeEl = document.getElementById('fullTimeRiders');
        if (fullTimeEl) {
            const fullTimeCount =
                stats.fullTimeRiders !== undefined
                    ? stats.fullTimeRiders
                    : (stats.totalRiders || 0) - (stats.partTimeRiders || 0);
            fullTimeEl.textContent = fullTimeCount;
        }

        const trainingEl = document.getElementById('inTraining');
        if (trainingEl) {
            trainingEl.textContent = stats.inTraining || 0;
        }

    }



// Debug function to test delete functionality
function testDeleteFunction() {
  if (app.riders && app.riders.length > 0) {
    const firstRider = app.riders[0];
    const riderId = firstRider.jpNumber || firstRider['Rider ID'];
    console.log('üß™ Testing delete function with first rider:', riderId);
    
    if (confirm('This is a test. Do you want to test the delete function (no actual deletion will occur)?')) {
      console.log('‚úÖ Delete function test would proceed with rider:', riderId);
      showSuccess('Delete function test completed - no actual deletion performed');
    }
  } else {
    console.log('‚ùå No riders available for testing');
  }
}

/**
 * SEARCH FIX: Replace the filterRiders function in your riders.html
 * This function handles both search and status filtering
 */

function filterRiders() {
  console.log('üîç filterRiders called');
  
  const searchBox = document.getElementById('searchBox');
  const statusFilter = document.getElementById('statusFilter');
  const motorFilter = document.getElementById('motorFilter');

  if (!searchBox || !statusFilter) {
    console.error('‚ùå Search elements not found');
    return;
  }
  
  const searchTerm = searchBox.value.toLowerCase().trim();
  const statusFilter_value = statusFilter.value;
  const motorFilter_value = motorFilter ? motorFilter.value : 'Motors';
  
  console.log(`üîç Filtering: search="${searchTerm}" status="${statusFilter_value}" motors="${motorFilter_value}"`);
  console.log(`üìä Total riders to filter: ${app.riders.length}`);
  
  if (!app.riders || app.riders.length === 0) {
    console.warn('‚ö†Ô∏è No riders data to filter');
    showEmptyState();
    return;
  }
  
  // Apply filters
  app.filteredRiders = app.riders.filter((rider, index) => {
    try {
      // Get rider data with multiple field name options
      const name = rider.name || rider['Full Name'] || '';
      const riderId = rider.jpNumber || rider['Rider ID'] || '';
      const phone = rider.phone || rider['Phone Number'] || '';
      const email = rider.email || rider['Email'] || '';
      const status = rider.status || rider['Status'] || 'Active';
      const certification = rider.certification || rider['Certification'] || '';
      
      // Debug first few riders during filtering
      if (index < 3 && searchTerm) {
        console.log(`  Checking rider ${index + 1}: name="${name}" id="${riderId}" status="${status}"`);
      }
      
      // Search filter (if search term provided)
      let matchesSearch = true;
      if (searchTerm) {
        matchesSearch = 
          name.toLowerCase().includes(searchTerm) ||
          riderId.toLowerCase().includes(searchTerm) ||
          phone.toLowerCase().includes(searchTerm) ||
          email.toLowerCase().includes(searchTerm);
      }
      
      // Status filter (if not "All")
      let matchesStatus = true;
      if (statusFilter_value && statusFilter_value !== 'All') {
        matchesStatus = status === statusFilter_value;
      }

      // Motor filter
      let matchesMotor = true;
      if (motorFilter_value === 'Motors') {
        const certLower = certification.toLowerCase();


matchesMotor = certLower === 'standard' || certLower === 'instructor';

      }

      const shouldInclude = matchesSearch && matchesStatus && matchesMotor;
      
      // Debug matches for first few riders
      if (index < 3 && searchTerm) {
        console.log(`    Search match: ${matchesSearch}, Status match: ${matchesStatus}, Motor match: ${matchesMotor}, Include: ${shouldInclude}`);
      }
      
      return shouldInclude;
      
    } catch (error) {
      console.warn(`‚ö†Ô∏è Error filtering rider ${index}:`, error);
      return false;
    }
  });
  
  console.log(`‚úÖ Filtered results: ${app.filteredRiders.length} riders`);
  
  // Update display
  if (app.filteredRiders.length > 0) {
    renderRidersTable(app.filteredRiders);
    showTable();
  } else {
    showEmptyState();
  }
}

/**
 * IMPROVED: Better event listener setup
 * Replace the setupEventListeners function in riders.html
 */
function setupEventListeners() {
  console.log('üîß Setting up event listeners...');
  
  // Search box with multiple event types
  const searchBox = document.getElementById('searchBox');
  if (searchBox) {
    console.log('‚úÖ Search box found, adding listeners');
    
    // Remove any existing listeners
    searchBox.removeEventListener('input', filterRiders);
    searchBox.removeEventListener('keyup', filterRiders);
    searchBox.removeEventListener('change', filterRiders);
    
    // Add multiple event listeners for better responsiveness
    searchBox.addEventListener('input', debounce(filterRiders, 300));
    searchBox.addEventListener('keyup', debounce(filterRiders, 300));
    searchBox.addEventListener('change', filterRiders);
    
    console.log('‚úÖ Search box listeners added');
  } else {
    console.error('‚ùå Search box not found!');
  }
  
  // Status filter
  const statusFilter = document.getElementById('statusFilter');
  const motorFilter = document.getElementById('motorFilter');
  if (statusFilter) {
    console.log('‚úÖ Status filter found, adding listener');
    statusFilter.addEventListener('change', filterRiders);
  } else {
    console.error('‚ùå Status filter not found!');
  }

  if (motorFilter) {
    console.log('‚úÖ Motor filter found, adding listener');
    motorFilter.addEventListener('change', filterRiders);
  } else {
    console.error('‚ùå Motor filter not found!');
  }
  
  // Modal close on outside click
  window.onclick = function(event) {
    const modal = document.getElementById('riderModal');
    if (event.target === modal) {
      closeRiderModal();
    }
  }
  
  console.log('‚úÖ Event listeners setup complete');
}

/**
 * IMPROVED: Better debounce function
 * Make sure this debounce function exists in riders.html
 */
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

/**
 * TEST SEARCH: Add this function to test search manually
 * Add this to riders.html and call it from browser console
 */
function testSearch(searchTerm = 'test') {
  console.log(`üß™ Testing search with term: "${searchTerm}"`);
  
  const searchBox = document.getElementById('searchBox');
  if (!searchBox) {
    console.error('‚ùå Search box not found');
    return;
  }
  
  // Set the search value
  searchBox.value = searchTerm;
  
  // Trigger the search
  console.log('üîç Triggering filterRiders...');
  filterRiders();
  
  console.log('‚úÖ Search test complete');
}

function openAddRiderModal() {
        document.getElementById('modalTitle').textContent = 'Add New Rider';
        document.getElementById('riderForm').reset();
        document.getElementById('originalRiderId').value = '';
        document.getElementById('deleteRiderBtn').style.display = 'none';
        document.getElementById('riderModal').style.display = 'block';
    }

function editRider(riderId) {
  console.log('üñ±Ô∏è Edit button clicked for rider ID:', riderId, 'Type:', typeof riderId);
  console.log('üîç Available riders in app.riders:', app.riders.length);
  
  // Debug: Show first few riders and their ID structure
  if (app.riders.length > 0) {
    console.log('üìä First 3 riders structure:');
    app.riders.slice(0, 3).forEach((r, i) => {
      console.log(`  ${i + 1}:`, {
        jpNumber: r.jpNumber,
        'Rider ID': r['Rider ID'],
        name: r.name,
        allKeys: Object.keys(r)
      });
    });
  }
  
  // Try multiple search strategies
  let rider = null;
  let searchMethod = '';
  
  // Strategy 1: Search by jpNumber (exact match)
  rider = app.riders.find(r => r.jpNumber === riderId);
  if (rider) {
    searchMethod = 'jpNumber exact match';
  } else {
    // Strategy 2: Search by jpNumber (string comparison)
    rider = app.riders.find(r => String(r.jpNumber) === String(riderId));
    if (rider) {
      searchMethod = 'jpNumber string match';
    } else {
      // Strategy 3: Search by 'Rider ID' field (column name)
      rider = app.riders.find(r => r['Rider ID'] === riderId);
      if (rider) {
        searchMethod = 'Rider ID field exact match';
      } else {
        // Strategy 4: Search by 'Rider ID' field (string comparison)
        rider = app.riders.find(r => String(r['Rider ID']) === String(riderId));
        if (rider) {
          searchMethod = 'Rider ID field string match';
        } else {
          // Strategy 5: Search by any field that might contain the ID
          rider = app.riders.find(r => {
            return Object.values(r).some(value => String(value) === String(riderId));
          });
          if (rider) {
            searchMethod = 'found in any field';
          }
        }
      }
    }
  }
  
  if (!rider) {
    console.error('‚ùå Rider not found with any strategy');
    console.log('üîç All rider IDs available:');
    app.riders.forEach((r, i) => {
      console.log(`  ${i + 1}: jpNumber="${r.jpNumber}" | Rider ID="${r['Rider ID']}" | Name="${r.name}"`);
    });
    
    showError(`Rider with ID "${riderId}" not found. Available riders: ${app.riders.length}`);
    return;
  }
  
  console.log(`‚úÖ Found rider via ${searchMethod}:`, rider.name);
  
  // Proceed with edit modal
  document.getElementById('modalTitle').textContent = 'Edit Rider';
  document.getElementById('originalRiderId').value = riderId;
  
  // Use the correct field names based on what we found
  document.getElementById('riderId').value = rider.jpNumber || rider['Rider ID'] || '';
  document.getElementById('riderPayroll').value = rider.payrollNumber || rider['Payroll Number'] || '';
  document.getElementById('riderName').value = rider.name || rider['Full Name'] || '';
  document.getElementById('riderPhone').value = rider.phone || rider['Phone Number'] || '';
  document.getElementById('riderEmail').value = rider.email || rider['Email'] || '';
  document.getElementById('riderStatus').value = rider.status || rider['Status'] || 'Active';
  document.getElementById('riderPlatoon').value = rider.platoon || rider['Platoon'] || '';
  document.getElementById('riderPartTime').value = rider.partTime || rider['Part Time'] || 'No';
  document.getElementById('riderCertification').value = rider.certification || rider['Certification'] || 'Standard';
  document.getElementById('riderOrganization').value = rider.organization || rider['Organization'] || 'Internal (Default)';

  document.getElementById('deleteRiderBtn').style.display = 'inline-block';

  document.getElementById('riderModal').style.display = 'block';
}

function closeRiderModal() {
    document.getElementById('riderModal').style.display = 'none';
}

function deleteCurrentRider() {
  const riderId = document.getElementById('originalRiderId').value;
  if (!riderId) {
    alert('No rider selected for deletion');
    return;
  }
  deleteRider(riderId);
}
/**
    function saveRider() {
        const formData = new FormData(document.getElementById('riderForm'));
        const isUpdate = document.getElementById('originalRiderId').value;
        
        // Map to your CONFIG column names
        const riderData = {
            'Rider ID': formData.get('riderId'),
            'Full Name': formData.get('riderName'),
            'Phone Number': formData.get('riderPhone'),
            'Email': formData.get('riderEmail'),
            'Status': formData.get('riderStatus'),
            'Certification': formData.get('riderCertification')
        };

        // Validate required fields
        if (!riderData['Rider ID'] || !riderData['Full Name'] || !riderData['Phone Number']) {
            showError('Please fill in all required fields');
            return;
        }

        showLoading('Saving rider...');
        
        const action = isUpdate ? 'update' : 'create';
        
        google.script.run
            .withSuccessHandler(handleRiderOperationSuccess)
            .withFailureHandler(handleRiderOperationFailure)
            .handleRiderOperation(action, riderData);
    }
*/
function deleteRider(riderId) {
  console.log('üóëÔ∏è Delete button clicked for rider ID:', riderId);
  
  // Find the rider to get their name for confirmation
  const rider = app.riders.find(r => 
    r.jpNumber === riderId || 
    r['Rider ID'] === riderId ||
    String(r.jpNumber) === String(riderId) ||
    String(r['Rider ID']) === String(riderId)
  );
  
  const riderName = rider ? (rider.name || rider['Full Name'] || 'Unknown Rider') : riderId;
  
  // Enhanced confirmation dialog
  const confirmMessage = `‚ö†Ô∏è DELETE RIDER CONFIRMATION\n\n` +
    `Rider: ${riderName}\n` +
    `ID: ${riderId}\n\n` +
    `This will permanently delete this rider from the system.\n` +
    `This action CANNOT be undone.\n\n` +
    `Are you absolutely sure you want to proceed?`;
  
  if (!confirm(confirmMessage)) {
    console.log('‚ùå Rider deletion cancelled by user');
    return;
  }

  // Show loading state
  showLoading('Deleting rider...');
  
  console.log(`üóëÔ∏è Proceeding with deletion of rider: ${riderName} (ID: ${riderId})`);
  
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('‚úÖ Delete operation completed:', result);
        handleRiderOperationSuccess(result);
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå Delete operation failed:', error);
        handleRiderOperationFailure(error);
      })
      .handleRiderOperation('delete', { riderId: riderId });
  } else {
    console.error('‚ùå Google Apps Script not available');
    handleRiderOperationFailure({ message: "Google Apps Script not available." });
  }
}


function saveRider() {
  console.log('üíæ saveRider called');
  
  const formData = new FormData(document.getElementById('riderForm'));
  const isUpdate = document.getElementById('originalRiderId').value;
  
  // Debug: Show all form data
  console.log('üìã Form data collected:');
  for (let [key, value] of formData.entries()) {
    console.log(`  ${key}: "${value}"`);
  }
  
  // Map to your CONFIG column names
  const riderData = {
    'Rider ID': formData.get('riderId'),
    'Payroll Number': formData.get('riderPayroll'),
    'Full Name': formData.get('riderName'),
    'Phone Number': formData.get('riderPhone'),
    'Email': formData.get('riderEmail'),
    'Status': formData.get('riderStatus'),
    'Platoon': formData.get('riderPlatoon'),
    'Part Time': formData.get('riderPartTime'),
    'Certification': formData.get('riderCertification'), // ‚Üê Check this value
    'Organization': formData.get('riderOrganization') // ‚Üê Add this value
  };
  
  console.log('üóÇÔ∏è Mapped rider data:', riderData);
  console.log(`üìú Certification value: "${riderData['Certification']}" (length: ${riderData['Certification']?.length})`);
  
  // Validate required fields
  if (!riderData['Rider ID'] || !riderData['Full Name'] || !riderData['Phone Number']) {
    const missingFields = [];
    if (!riderData['Rider ID']) missingFields.push('Rider ID');
    if (!riderData['Full Name']) missingFields.push('Full Name');
    if (!riderData['Phone Number']) missingFields.push('Phone Number');
    
    console.error('‚ùå Missing required fields:', missingFields);
    showError('Please fill in all required fields: ' + missingFields.join(', '));
    return;
  }

  if (riderData['Payroll Number'] && !/^\d{5,8}$/.test(riderData['Payroll Number'])) {
    showError('Payroll Number must be 5-8 digits');
    return;
  }
  
  // Special check for certification
  const certification = riderData['Certification'];
  if (!certification || certification.trim() === '') {
    console.warn('‚ö†Ô∏è No certification selected, using default');
    riderData['Certification'] = 'Standard';
  }
  
  console.log('‚úÖ Validation passed, sending to server...');
  showLoading('Saving rider...');
  
  const action = isUpdate ? 'update' : 'create';
  console.log(`üì§ Calling handleRiderOperation: action="${action}"`);
  
  google.script.run
    .withSuccessHandler(handleRiderOperationSuccess)
    .withFailureHandler(handleRiderOperationFailure)
    .handleRiderOperation(action, riderData);
}
/**
 * INITIALIZE SEARCH: Make sure this runs after data loads
 * Update your handleRidersDataSuccess function in riders.html
 */
function handleRidersDataSuccess(data) {
  console.log('üéØ handleRidersDataSuccess called with data:', data);
  hideLoading();
  
  // Enhanced validation and debugging
  if (!data) {
    console.error('‚ùå No data received from backend');
    showError('No data received from server');
    return;
  }
  
  console.log('üìä Data validation:');
  console.log(`  - data.success: ${data.success}`);
  console.log(`  - data.riders: ${data.riders ? `Array(${data.riders.length})` : 'null/undefined'}`);
  console.log(`  - data.user: ${data.user ? 'present' : 'null/undefined'}`);
  console.log(`  - data.stats: ${data.stats ? 'present' : 'null/undefined'}`);
  console.log(`  - data.error: ${data.error || 'none'}`);
  
  if (data && data.success) {
    console.log('‚úÖ Data validation passed, processing riders...');
    
    // Store data in app state
    app.user = data.user;
    app.riders = data.riders || [];
    app.filteredRiders = [...app.riders]; // Initialize filtered riders
    
    console.log(`üìã Stored ${app.riders.length} riders in app state`);
    
    // Sample first few riders for debugging
    if (app.riders.length > 0) {
      console.log('üîç Sample riders:');
      app.riders.slice(0, 3).forEach((rider, i) => {
        console.log(`  ${i + 1}. ${rider.name || 'No Name'} (${rider.jpNumber || 'No ID'}) - Status: ${rider.status || 'No Status'}`);
      });
    }
    
    // Update UI components
    try {
      console.log('üîÑ Updating user info...');
      updateUserInfo(data.user);
      
      console.log('üìä Updating stats...');
      updateStats(data.stats);
      
      console.log('üìã Rendering riders table...');
      renderRidersTable(app.filteredRiders);
      
      console.log('üëÅÔ∏è Showing table...');
      showTable();
      
      console.log('üìû Fetching assignment counts...');
      fetchAssignmentCountsForRiders(app.filteredRiders);

      console.log('üîß Setting up event listeners...');
      setupEventListeners();

      console.log('üîç Applying initial filters...');
      filterRiders();

      // Apply filter from URL if provided
      const params = new URLSearchParams(window.location.search);
      const statusParam = params.get('status');
      if (statusParam) {
        console.log(`üîó Applying URL filter: ${statusParam}`);
        const statusFilter = document.getElementById('statusFilter');
        if (statusFilter) {
          statusFilter.value = statusParam;
          filterRiders();
        }
      }
      
      console.log(`‚úÖ Riders page setup complete with ${app.riders.length} riders`);
      
    } catch (uiError) {
      console.error('‚ùå Error during UI setup:', uiError);
      showError('Error setting up riders page: ' + uiError.message);
    }
    
  } else {
    console.error('‚ùå Backend returned unsuccessful response');
    console.error('   - data.success:', data.success);
    console.error('   - data.error:', data.error);
    showError('Failed to load riders: ' + (data ? data.error : 'Unknown error'));
  }
}

function handleRiderOperationSuccess(result) {
  hideLoading();
  
  console.log('‚úÖ Rider operation successful:', result);
  
  if (result && result.success) {
    showSuccess(result.message || 'Operation completed successfully');
    
    // Close the modal
    closeRiderModal();
    
    // Refresh the riders list to show changes
    loadRidersData();
    
  } else {
    showError('Operation failed: ' + (result ? result.message : 'Unknown error'));
  }
}

function handleRiderOperationFailure(error) {
  hideLoading();
  console.error('‚ùå Rider operation failed:', error);
  showError('Operation failed: ' + (error.message || error));
}

function deleteRider(riderId) {
  console.log('üóëÔ∏è Delete button clicked for rider ID:', riderId);
  
  // Find the rider to get their name for confirmation
  const rider = app.riders.find(r => 
    r.jpNumber === riderId || 
    r['Rider ID'] === riderId ||
    String(r.jpNumber) === String(riderId) ||
    String(r['Rider ID']) === String(riderId)
  );
  
  const riderName = rider ? (rider.name || rider['Full Name'] || 'Unknown Rider') : riderId;
  
  // Enhanced confirmation dialog
  const confirmMessage = `‚ö†Ô∏è DELETE RIDER CONFIRMATION\n\n` +
    `Rider: ${riderName}\n` +
    `ID: ${riderId}\n\n` +
    `This will permanently delete this rider from the system.\n` +
    `This action CANNOT be undone.\n\n` +
    `Are you absolutely sure you want to proceed?`;
  
  if (!confirm(confirmMessage)) {
    console.log('‚ùå Rider deletion cancelled by user');
    return;
  }

  // Show loading state
  showLoading('Deleting rider...');
  
  console.log(`üóëÔ∏è Proceeding with deletion of rider: ${riderName} (ID: ${riderId})`);
  
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('‚úÖ Delete operation completed:', result);
        handleRiderOperationSuccess(result);
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå Delete operation failed:', error);
        handleRiderOperationFailure(error);
      })
      .handleRiderOperation('delete', { riderId: riderId });
  } else {
    console.error('‚ùå Google Apps Script not available');
    handleRiderOperationFailure({ message: "Google Apps Script not available." });
  }
}

if (typeof handleRiderOperationFailure === 'undefined') {
  window.handleRiderOperationFailure = function(error) {
    hideLoading();
    showError('Operation failed: ' + (error.message || error));
  };
}

    function handleExportSuccess(result) {
        hideLoading();
        
        if (result && result.success) {
            // Create and download CSV file
            const blob = new Blob([result.csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = result.filename;
            a.click();
            URL.revokeObjectURL(url);
            
            showSuccess(`Exported ${result.count} riders successfully`);
        } else {
            showError('Export failed: ' + (result ? result.message : 'Unknown error'));
        }
    }

    // Bulk operations
    function toggleBulkMode() {
        app.bulkMode = !app.bulkMode;
        const panel = document.getElementById('bulkActionsPanel');
        const btn = document.getElementById('bulkModeBtn');
        
        if (app.bulkMode) {
            panel.classList.add('show');
            btn.textContent = '‚ùå Exit Bulk Mode';
            btn.className = 'btn btn-danger';
        } else {
            panel.classList.remove('show');
            btn.textContent = 'üìã Bulk Actions';
            btn.className = 'btn btn-warning';
            clearSelection();
        }
    }

    function toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const checkboxes = document.querySelectorAll('.rider-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
        
        updateSelection();
    }

    function updateSelection() {
        const checkboxes = document.querySelectorAll('.rider-checkbox:checked');
        app.selectedRiders.clear();
        
        checkboxes.forEach(checkbox => {
            app.selectedRiders.add(checkbox.dataset.riderId);
        });
        
        document.getElementById('selectedCount').textContent = app.selectedRiders.size;
        
        // Update select all checkbox
        const totalCheckboxes = document.querySelectorAll('.rider-checkbox').length;
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        selectAllCheckbox.indeterminate = app.selectedRiders.size > 0 && app.selectedRiders.size < totalCheckboxes;
        selectAllCheckbox.checked = app.selectedRiders.size === totalCheckboxes && totalCheckboxes > 0;
    }

    function clearSelection() {
        app.selectedRiders.clear();
        document.querySelectorAll('.rider-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        document.getElementById('selectAllCheckbox').checked = false;
        updateSelection();
    }

    function applyBulkStatusUpdate() {
        const newStatus = document.getElementById('bulkStatusSelect').value;
        
        if (!newStatus) {
            showError('Please select a status');
            return;
        }
        
        if (app.selectedRiders.size === 0) {
            showError('Please select riders to update');
            return;
        }
        
        const riderIds = Array.from(app.selectedRiders);
        
        if (!confirm(`Update status to "${newStatus}" for ${riderIds.length} selected rider(s)?`)) {
            return;
        }
        
        showLoading('Updating rider statuses...');
        
        google.script.run
            .withSuccessHandler(handleBulkUpdateSuccess)
            .withFailureHandler(handleRiderOperationFailure)
            .handleRiderOperation('bulkUpdateStatus', { riderIds: riderIds, newStatus: newStatus });
    }

    function handleBulkUpdateSuccess(result) {
        hideLoading();
        
        if (result && result.success) {
            showSuccess(`Bulk update completed: ${result.successCount} successful, ${result.failureCount} failed`);
            clearSelection();
            loadRidersData(); // Refresh the list
        } else {
            showError('Bulk update failed: ' + (result ? result.message : 'Unknown error'));
        }
    }

    // UI state functions
    function showLoading(message = 'Loading...') {
        document.getElementById('loadingDiv').style.display = 'block';
        document.getElementById('tableDiv').style.display = 'none';
        document.getElementById('emptyStateDiv').style.display = 'none';
        document.getElementById('loadingDiv').innerHTML = `üîÑ ${message}`;
    }

    function hideLoading() {
        document.getElementById('loadingDiv').style.display = 'none';
    }

    function showTable() {
        document.getElementById('tableDiv').style.display = 'block';
        document.getElementById('emptyStateDiv').style.display = 'none';
    }

    function showEmptyState() {
        document.getElementById('tableDiv').style.display = 'none';
        document.getElementById('emptyStateDiv').style.display = 'block';
    }

    function showSuccess(message) {
        showNotification(message, '#27ae60');
    }

    function showError(message) {
        showNotification('Error: ' + message, '#e74c3c');
    }

    function showNotification(message, color) {
        const notification = document.createElement('div');
        notification.style.position = 'fixed';
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.background = color;
        notification.style.color = 'white';
        notification.style.padding = '1rem';
        notification.style.borderRadius = '5px';
        notification.style.zIndex = '9999';
        notification.style.maxWidth = '300px';
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

<!-- Add these functions to your riders.html <script> section -->

// Enhanced renderRidersTable with clickable rider names
function renderRidersTable(riders) {
  const tbody = document.getElementById('ridersTableBody');
  
  if (!riders || riders.length === 0) {
    showEmptyState();
    return;
  }

  // Clear existing content
  tbody.innerHTML = '';

  riders.forEach((rider, index) => {
    // Get the rider ID - try multiple field names
    const riderId = rider.jpNumber || rider['Rider ID'] || rider.riderId || `rider-${index}`;
    const riderName = rider.name || rider['Full Name'] || 'Unknown';
    const payrollNumber = rider.payrollNumber || rider['Payroll Number'] || '';
    const riderPhone = rider.phone || rider['Phone Number'] || '';
    const riderEmail = rider.email || rider['Email'] || '';
    const riderStatus = rider.status || rider['Status'] || 'Active';
    const riderPlatoon = rider.platoon || rider['Platoon'] || '';
    const riderPartTime = rider.partTime || rider['Part Time'] || 'No';
    const riderCertification = rider.certification || rider['Certification'] || 'Standard';
    const totalAssignments = rider.totalAssignments || rider['Total Assignments'] || 0;
    const lastAssignment = rider.lastAssignmentDate || rider['Last Assignment Date'] || 'Never';

    // Create clickable rider name with assignment count
    const riderNameCell = createRiderNameLink(riderName, riderId, totalAssignments);

    // Create table row
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="checkbox-column">
        <input type="checkbox" class="rider-checkbox" data-rider-id="${riderId}" onchange="updateSelection()">
      </td>
      <td>${riderId}</td>
      <td>${payrollNumber}</td>
      <td class="rider-name-cell">${riderNameCell}</td>
      <td class="rider-phone-cell">${riderPhone}</td>
      <td>${riderEmail}</td>
      <td><span class="status-badge status-${riderStatus.toLowerCase()}">${riderStatus}</span></td>
      <td>${riderPlatoon}</td>
      <td>${riderPartTime}</td>
      <td>${riderCertification}</td>
      <td>${rider.organization || rider['Organization'] || 'Internal'}</td>
      <td id="assign-count-${riderId}">${totalAssignments}</td>
      <td id="last-assignment-${riderId}">${lastAssignment}</td>
      <td class="actions-cell">
        <button onclick="editRider('${riderId}')" class="btn btn-sm btn-primary" title="Edit ${riderName}">
          ‚úèÔ∏è Edit
        </button>
      </td>
    `;

    tbody.appendChild(tr);
  });

  console.log(`‚úÖ Rendered ${riders.length} riders in table with clickable names`);
}

// Create clickable rider name link
function createRiderNameLink(riderName, riderId, totalAssignments) {
  const hasAssignments = totalAssignments && totalAssignments > 0;
  const linkTitle = hasAssignments
    ? `View ${totalAssignments} upcoming assignment(s) for ${riderName}`
    : `${riderName} - No upcoming assignments`;
  
  return `
    <a href="#"
       data-rider-id="${riderId}"
       class="rider-name-link ${hasAssignments ? 'has-assignments' : 'no-assignments'}"
       onclick="viewRiderAssignments('${riderId}', '${riderName.replace(/'/g, "\\'")}'); return false;"
       title="${linkTitle}">
      ${riderName}
      ${hasAssignments ? ` <span class="assignment-count">(${totalAssignments})</span>` : ''}
    </a>
  `;
}

// Fetch assignment counts for each rider and update tooltips
function fetchAssignmentCountsForRiders(riders) {
  if (!(typeof google !== 'undefined' && google.script && google.script.run)) {
    return; // Google Apps Script not available
  }

  riders.forEach(rider => {
    const riderId = rider.jpNumber || rider['Rider ID'];
    const riderName = rider.name || rider['Full Name'];
    if (!riderId || !riderName) return;

    google.script.run
      .withSuccessHandler(summary => {
        const count = summary && summary.summary ? summary.summary.upcoming : 0;
        let lastDate = '';
        if (summary && summary.assignments && summary.assignments.length > 0) {
          const dates = summary.assignments
            .map(a => new Date(a.eventDate))
            .filter(d => !isNaN(d));
          if (dates.length > 0) {
            const latest = new Date(Math.max(...dates.map(d => d.getTime())));
            lastDate = latest.toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric'
            });
          }
        }
        const link = document.querySelector(
          `.rider-name-link[data-rider-id="${riderId}"]`
        );
        if (link) {
          if (count > 0) {
            link.title = `View ${count} upcoming assignment(s) for ${riderName}`;
            let span = link.querySelector('.assignment-count');
            if (!span) {
              span = document.createElement('span');
              span.className = 'assignment-count';
              link.appendChild(span);
            }
            span.textContent = `(${count})`;
            link.classList.add('has-assignments');
            link.classList.remove('no-assignments');
          } else {
            link.title = `${riderName} - No upcoming assignments`;
            const span = link.querySelector('.assignment-count');
            if (span) span.remove();
            link.classList.add('no-assignments');
            link.classList.remove('has-assignments');
          }
        }

        const countCell = document.getElementById(`assign-count-${riderId}`);
        if (countCell) {
          countCell.textContent = count;
        }
        const lastCell = document.getElementById(`last-assignment-${riderId}`);
        if (lastCell) {
          lastCell.textContent = lastDate || 'Never';
        }
      })
      .withFailureHandler(err => {
        console.error('Failed to fetch assignment summary', err);
      })
      .getRiderAssignmentSummary(riderId, riderName);
  });
}

// Main function to view rider assignments
function viewRiderAssignments(riderId, riderName) {
  console.log(`üîç Viewing assignments for rider: ${riderName} (ID: ${riderId})`);
  
  showLoading(`Loading assignments for ${riderName}...`);
  
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(function(result) {
        hideLoading();
        displayRiderAssignments(result, riderName, riderId);
      })
      .withFailureHandler(function(error) {
        hideLoading();
        showError(`Failed to load assignments for ${riderName}: ${error.message || error}`);
      })
      .getRiderAssignments(riderId, riderName);
  } else {
    hideLoading();
    // Fallback: Navigate to assignments page with rider filter
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run.withSuccessHandler(function(url) {
        window.open(`${url}?page=assignments&rider=${encodeURIComponent(riderName)}`, '_blank');
      }).getWebAppUrl();
    } else {
      const baseUrl = 'assignments.html';
      window.open(`${baseUrl}?rider=${encodeURIComponent(riderName)}`, '_blank');
    }
  }
}

// Display rider assignments in a modal
function displayRiderAssignments(assignments, riderName, riderId) {
  console.log(`üìã Displaying ${assignments.length} assignments for ${riderName}`);
  
  // Create or get the assignments modal
  let modal = document.getElementById('assignmentsModal');
  if (!modal) {
    modal = createAssignmentsModal();
  }
  
  const modalTitle = document.getElementById('assignmentsModalTitle');
  const modalBody = document.getElementById('assignmentsModalBody');
  
  modalTitle.textContent = `üèçÔ∏è Assignments for ${riderName}`;
  
  if (!assignments || assignments.length === 0) {
    modalBody.innerHTML = `
      <div class="no-assignments">
        <p><strong>${riderName}</strong> has no current assignments.</p>
        <p>They are available for new assignments.</p>
      </div>
    `;
  } else {
    modalBody.innerHTML = createAssignmentsTable(assignments, riderName);
  }
  
  modal.style.display = 'block';
}

// Create assignments modal HTML
function createAssignmentsModal() {
  const modal = document.createElement('div');
  modal.id = 'assignmentsModal';
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-content assignments-modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="assignmentsModalTitle">Rider Assignments</h3>
        <span class="close" onclick="closeAssignmentsModal()">&times;</span>
      </div>
      <div class="modal-body" id="assignmentsModalBody">
        Loading assignments...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="goToAssignmentsPage()">
          üìã View All Assignments
        </button>
        <button type="button" class="btn btn-secondary" onclick="closeAssignmentsModal()">
          Close
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  return modal;
}

// Create assignments table HTML
function createAssignmentsTable(assignments, riderName) {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  // Separate upcoming and past assignments
  const upcoming = [];
  const past = [];
  
  assignments.forEach(assignment => {
    try {
      const eventDate = new Date(assignment.eventDate || assignment.date);
      if (eventDate >= today) {
        upcoming.push(assignment);
      } else {
        past.push(assignment);
      }
    } catch (e) {
      upcoming.push(assignment); // Default to upcoming if date parsing fails
    }
  });
  
  let html = '';
  
  // Upcoming assignments section
  if (upcoming.length > 0) {
    html += `
      <div class="assignments-section">
        <h4>üîú Upcoming Assignments (${upcoming.length})</h4>
        <div class="assignments-table-container">
          <table class="assignments-table">
            <thead>
              <tr>
                <th>Request ID</th>
                <th>Date</th>
                <th>Time</th>
                <th>Location</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${upcoming.map(assignment => createAssignmentRow(assignment)).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
  }
  
  // Past assignments section (show last 5)
  if (past.length > 0) {
    const recentPast = past.slice(0, 5);
    html += `
      <div class="assignments-section">
        <h4>üìÖ Recent Past Assignments (${recentPast.length}${past.length > 5 ? ` of ${past.length}` : ''})</h4>
        <div class="assignments-table-container">
          <table class="assignments-table">
            <thead>
              <tr>
                <th>Request ID</th>
                <th>Date</th>
                <th>Time</th>
                <th>Location</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${recentPast.map(assignment => createAssignmentRow(assignment, true)).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
  }
  
  return html;
}

// Create individual assignment row
function createAssignmentRow(assignment, isPast = false) {
  const requestId = assignment.requestId || assignment.id || 'Unknown';
  const eventDate = assignment.eventDate || assignment.date || 'No Date';
  const startTime = assignment.startTime || assignment.time || 'No Time';
  const location = assignment.startLocation || assignment.location || 'Location TBD';
  const status = assignment.status || 'Assigned';
  
  const statusClass = status.toLowerCase().replace(' ', '-');
  const actionButtons = isPast ? '' : `
    <td class="assignment-actions">
      <a class="btn btn-sm btn-info" title="View Assignment Details"
         href="#"
         onclick="openAssignment('${requestId}'); return false;">
        üëÅÔ∏è View
      </a>
    </td>
  `;
  
  return `
    <tr class="assignment-row ${isPast ? 'past-assignment' : 'upcoming-assignment'}">
      <td class="request-id">
        <a href="#" class="request-link"
           onclick="openAssignment('${requestId}'); return false;">
          ${requestId}
        </a>
      </td>
      <td class="event-date">${eventDate}</td>
      <td class="start-time">${startTime}</td>
      <td class="location">${location}</td>
      <td class="status">
        <span class="status-badge status-${statusClass}">${status}</span>
      </td>
      ${actionButtons || '<td></td>'}
    </tr>
  `;
}

// View request details
function viewRequestDetails(requestId) {
  console.log(`üìã Viewing details for request: ${requestId}`);
  closeAssignmentsModal();

  // Navigate to requests page with the specific request highlighted
  navigateTo('requests', { highlight: requestId });
}

// Open the assignments page for the given request
function openAssignment(requestId) {
  console.log(`üèçÔ∏è Opening assignment for request: ${requestId}`);
  closeAssignmentsModal();
  navigateTo('assignments', { requestId: requestId });
}

// Close assignments modal
function closeAssignmentsModal() {
  const modal = document.getElementById('assignmentsModal');
  if (modal) {
    modal.style.display = 'none';
  }
}

// Go to assignments page
function goToAssignmentsPage() {
  navigateTo('assignments');
}

// General navigation helper similar to other pages
function navigateTo(page, params = {}) {
  const search = new URLSearchParams();
  search.set('page', page);
  Object.keys(params).forEach(key => search.set(key, params[key]));

  function openUrl(base) {
    const url = base + '?' + search.toString();
    try {
      window.top.location.assign(url);
    } catch (error) {
      window.location.assign(url);
    }
  }

  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run.withSuccessHandler(openUrl).getWebAppUrl();
  } else {
    const base = page === 'dashboard' ? 'index.html' : page + '.html';
    openUrl(base);
  }
}

// Close modal when clicking outside
window.onclick = function(event) {
  const riderModal = document.getElementById('riderModal');
  const assignmentsModal = document.getElementById('assignmentsModal');
  
  if (event.target === riderModal) {
    closeRiderModal();
  }
  if (event.target === assignmentsModal) {
    closeAssignmentsModal();
  }
}

// Add CSS styles for the rider name links and assignments modal
const riderLinkStyles = `
<style>
/* Rider name link styles */
.rider-name-link {
  color: #3498db;
  text-decoration: none;
  font-weight: 500;
  transition: all 0.3s ease;
  cursor: pointer;
}

.rider-name-link:hover {
  color: #2980b9;
  text-decoration: underline;
}

.rider-name-link.has-assignments {
  color: #27ae60;
}

.rider-name-link.has-assignments:hover {
  color: #219a52;
}

.rider-name-link.no-assignments {
  color: #95a5a6;
}

.rider-name-link.no-assignments:hover {
  color: #7f8c8d;
}

.request-link {
  color: #2980b9;
  text-decoration: none;
  font-weight: 600;
}

.request-link:hover {
  text-decoration: underline;
}

.assignment-count {
  font-size: 0.85em;
  color: #e67e22;
  font-weight: 600;
}

/* Assignments modal styles */
.assignments-modal-content {
  max-width: 1000px;
  max-height: 80vh;
  overflow-y: auto;
}

.assignments-section {
  margin-bottom: 2rem;
}

.assignments-section h4 {
  color: #2c3e50;
  border-bottom: 2px solid #ecf0f1;
  padding-bottom: 0.5rem;
  margin-bottom: 1rem;
}

.assignments-table-container {
  overflow-x: auto;
  border-radius: 8px;
  border: 1px solid #ecf0f1;
}

.assignments-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.9rem;
}

.assignments-table th {
  background: #f8f9fa;
  padding: 0.75rem;
  text-align: left;
  font-weight: 600;
  color: #2c3e50;
  border-bottom: 1px solid #ecf0f1;
}

.assignments-table td {
  padding: 0.75rem;
  border-bottom: 1px solid #ecf0f1;
  vertical-align: middle;
}

.assignment-row:hover {
  background: rgba(52, 152, 219, 0.05);
}

.upcoming-assignment {
  background: rgba(46, 204, 113, 0.05);
}

.past-assignment {
  background: rgba(149, 165, 166, 0.05);
  opacity: 0.8;
}

.request-id .request-link {
  color: #2980b9;
}

.no-assignments {
  text-align: center;
  padding: 2rem;
  color: #7f8c8d;
}

.no-assignments p {
  margin: 0.5rem 0;
}

.assignment-actions {
  white-space: nowrap;
}

/* Responsive design */
@media (max-width: 768px) {
  .assignments-modal-content {
    margin: 5% auto;
    max-height: 90vh;
  }
  
  .assignments-table {
    font-size: 0.8rem;
  }
  
  .assignments-table th,
  .assignments-table td {
    padding: 0.5rem;
  }
}
  </style>
`;

function addScheduleLinks() {
  const nav = document.querySelector('nav.navigation');
  if (!nav) return;

  const params = new URLSearchParams(window.location.search);
  const currentPage = params.get('page');

  if (!nav.querySelector('[data-page="rider-schedule"]')) {
    const mySchedule = document.createElement('a');
    google.script.run.withSuccessHandler(url => { mySchedule.href = url + '?page=rider-schedule'; }).getWebAppUrl();
    mySchedule.className = 'nav-button';
    mySchedule.id = 'nav-rider-schedule';
    mySchedule.dataset.page = 'rider-schedule';
    mySchedule.textContent = 'üìÜ My Schedule';
    if (currentPage === 'rider-schedule') mySchedule.classList.add('active');
    nav.appendChild(mySchedule);
  }

  if (!nav.querySelector('[data-page="admin-schedule"]')) {
    const manageSchedules = document.createElement('a');
    google.script.run.withSuccessHandler(url => { manageSchedules.href = url + '?page=admin-schedule'; }).getWebAppUrl();
    manageSchedules.className = 'nav-button';
    manageSchedules.id = 'nav-admin-schedule';
    manageSchedules.dataset.page = 'admin-schedule';
    manageSchedules.textContent = 'üóìÔ∏è Manage Schedules';
    if (currentPage === 'admin-schedule') manageSchedules.classList.add('active');
    nav.appendChild(manageSchedules);
  }
}

// Add styles to document head
if (!document.getElementById('rider-link-styles')) {
  const styleSheet = document.createElement('div');
  styleSheet.id = 'rider-link-styles';
  styleSheet.innerHTML = riderLinkStyles;
  document.head.appendChild(styleSheet);
}

function logout() {
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(url => { window.location.href = url; })
      .logout();
  } else {
    window.location.href = 'https://accounts.google.com/Logout';
  }
}
</script>
</body>
</html>
