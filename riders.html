<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rider Directory</title>
  <style>
    :root {
      color-scheme: light dark;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f5f7fb;
      color: #1f2937;
    }

    header {
      background: linear-gradient(135deg, #3358d4, #1c3aa9);
      color: #ffffff;
      padding: 1.75rem 1rem;
      text-align: center;
      box-shadow: 0 4px 14px rgba(15, 23, 42, 0.18);
    }

    header h1 {
      margin: 0;
      font-size: clamp(1.75rem, 2.5vw + 1rem, 2.4rem);
      font-weight: 600;
    }

    main {
      max-width: 1100px;
      margin: 2.5rem auto;
      padding: 0 1.5rem 3rem;
    }

    .panel {
      background: #ffffff;
      border-radius: 16px;
      padding: 1.75rem 2rem;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.12);
    }

    .status-message {
      margin: 0 0 1.25rem;
      padding: 0.9rem 1.2rem;
      border-radius: 12px;
      background: #e8f0fe;
      color: #1a3d8f;
      font-weight: 500;
      text-align: center;
    }

    .status-message[hidden] {
      display: none;
    }

    .status-message.error {
      background: #fee2e2;
      color: #b91c1c;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 12px;
      overflow: hidden;
    }

    thead {
      background: #f1f5f9;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.75rem;
      color: #475569;
    }

    th,
    td {
      padding: 0.85rem 1rem;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    tbody tr:hover {
      background: #f8fafc;
    }

    .rider-name {
      color: #1d4ed8;
      font-weight: 600;
      text-decoration: none;
    }

    .rider-name:focus,
    .rider-name:hover {
      text-decoration: underline;
    }

    .calendar-link {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.45rem 0.85rem;
      border-radius: 999px;
      background: #dbeafe;
      color: #1d4ed8;
      text-decoration: none;
      font-weight: 600;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .calendar-link:hover,
    .calendar-link:focus {
      background: #bfdbfe;
      transform: translateY(-1px);
    }

    .calendar-link svg {
      width: 1rem;
      height: 1rem;
      fill: currentColor;
    }

    @media (max-width: 720px) {
      table,
      thead,
      tbody,
      th,
      td,
      tr {
        display: block;
      }

      thead {
        display: none;
      }

      tr {
        margin-bottom: 1.25rem;
        background: #ffffff;
        border-radius: 14px;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.1);
        overflow: hidden;
      }

      td {
        border: none;
        padding: 0.75rem 1rem;
      }

      td::before {
        content: attr(data-label);
        display: block;
        font-size: 0.75rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        margin-bottom: 0.35rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1 id="pageTitle">Rider Directory</h1>
  </header>

  <div id="navigation-container"></div>

  <main>
    <section class="panel">
      <p id="statusMessage" class="status-message" role="status" aria-live="polite">Loading riders…</p>
      <table id="ridersTable" hidden>
        <thead>
          <tr>
            <th scope="col">Rider ID</th>
            <th scope="col">Name</th>
            <th scope="col">Status</th>
            <th scope="col">Availability</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script>
    (function () {
      const statusMessage = document.getElementById('statusMessage');
      const ridersTable = document.getElementById('ridersTable');
      const ridersTbody = ridersTable.querySelector('tbody');
      const pageTitle = document.getElementById('pageTitle');
      let webAppBaseUrl = '';

      function setDocumentTitle() {
        if (pageTitle && pageTitle.textContent) {
          document.title = pageTitle.textContent.trim();
        }
      }

      function isAppsScriptAvailable() {
        return typeof google !== 'undefined' && google.script && google.script.run;
      }

      function showStatus(message, isError) {
        statusMessage.textContent = message;
        statusMessage.classList.toggle('error', Boolean(isError));
        statusMessage.hidden = false;
      }

      function hideStatus() {
        statusMessage.hidden = true;
      }

      function buildPageUrl(pageName, params) {
        const searchParams = new URLSearchParams(params || {});
        const fallbackUrl = `${pageName}.html${searchParams.toString() ? `?${searchParams}` : ''}`;

        if (!webAppBaseUrl) {
          return fallbackUrl;
        }

        try {
          const url = new URL(webAppBaseUrl);
          url.searchParams.set('page', pageName);
          for (const [key, value] of searchParams.entries()) {
            url.searchParams.set(key, value);
          }
          return url.toString();
        } catch (error) {
          console.warn('Falling back to relative URL due to error constructing page URL.', error);
          return fallbackUrl;
        }
      }

      function createCalendarLink(riderId) {
        const link = document.createElement('a');
        link.className = 'calendar-link';
        link.href = buildPageUrl('rider-availability', { riderId });
        link.target = '_blank';
        link.rel = 'noopener noreferrer';

        const icon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        icon.setAttribute('aria-hidden', 'true');
        icon.setAttribute('focusable', 'false');
        icon.setAttribute('viewBox', '0 0 20 20');

        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', 'M6 2a1 1 0 10-2 0v1H3a2 2 0 00-2 2v1h18V5a2 2 0 00-2-2h-1V2a1 1 0 10-2 0v1H6V2zM19 8H1v7a2 2 0 002 2h14a2 2 0 002-2V8zm-4.5 3a.5.5 0 01.5.5V13a1 1 0 01-1 1h-2a.5.5 0 01-.5-.5V11a1 1 0 011-1h2z');
        icon.appendChild(path);

        const label = document.createElement('span');
        label.textContent = 'View Calendar';

        link.append(icon, label);
        return link;
      }

      function createEditLink(riderId, name) {
        const link = document.createElement('a');
        link.className = 'rider-name';
        link.href = buildPageUrl('edit-rider', { riderId });
        link.target = '_top';
        link.textContent = name || 'Unnamed Rider';
        return link;
      }

      function renderRiderRow(rider) {
        const row = document.createElement('tr');

        const riderId = rider && rider.riderId ? String(rider.riderId) : '';
        const riderName = rider && rider.name ? String(rider.name) : 'Unnamed Rider';
        const riderStatus = rider && rider.status ? String(rider.status) : 'Unknown';

        const idCell = document.createElement('td');
        idCell.dataset.label = 'Rider ID';
        idCell.textContent = riderId;

        const nameCell = document.createElement('td');
        nameCell.dataset.label = 'Name';
        nameCell.appendChild(createEditLink(riderId, riderName));

        const statusCell = document.createElement('td');
        statusCell.dataset.label = 'Status';
        statusCell.textContent = riderStatus;

        const availabilityCell = document.createElement('td');
        availabilityCell.dataset.label = 'Availability';
        availabilityCell.appendChild(createCalendarLink(riderId));

        row.append(idCell, nameCell, statusCell, availabilityCell);
        return row;
      }

      function renderRiders(response) {
        if (!response || !response.success) {
          const message = response && response.message ? response.message : 'Unable to load riders.';
          showStatus(message, true);
          ridersTable.hidden = true;
          return;
        }

        const riders = Array.isArray(response.riders) ? response.riders : [];

        if (riders.length === 0) {
          showStatus('No riders found.', false);
          ridersTable.hidden = true;
          return;
        }

        ridersTbody.textContent = '';
        riders.forEach((rider) => {
          ridersTbody.appendChild(renderRiderRow(rider));
        });

        ridersTable.hidden = false;
        hideStatus();
      }

      function fetchRiders() {
        return new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .getRidersForPage();
        });
      }

      function fetchWebAppUrl() {
        return new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler((url) => resolve(typeof url === 'string' ? url : ''))
            .withFailureHandler(reject)
            .getWebAppUrl();
        });
      }

      async function initialize() {
        setDocumentTitle();

        if (!isAppsScriptAvailable()) {
          showStatus('Google Apps Script runtime unavailable.', true);
          return;
        }

        showStatus('Loading riders…', false);

        try {
          try {
            webAppBaseUrl = await fetchWebAppUrl();
          } catch (error) {
            webAppBaseUrl = '';
            console.warn('Could not determine base URL. Continuing with relative links.', error);
          }

          const response = await fetchRiders();
          renderRiders(response);
        } catch (error) {
          console.error('Failed to retrieve riders.', error);
          showStatus('Failed to retrieve riders.', true);
        }
      }

      document.addEventListener('DOMContentLoaded', initialize);
    })();
  </script>
  <script src="load-navigation.js"></script>
</body>
</html>
