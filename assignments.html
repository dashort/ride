<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assignments - Motorcycle Escort Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .navigation {
    justify-content: center !important;
    text-align: center !important;
    margin-left: auto !important;
    margin-right: auto !important;
}

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1rem;
        }

        .user-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
        }

        .user-role {
            font-size: 0.75rem;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

.navigation {
    display: flex !important;
    gap: 1rem !important;
    margin: 1rem auto 2rem auto !important;
    max-width: 1400px !important;
    padding: 0 2rem !important;
    flex-wrap: wrap !important;
    justify-content: center !important;
    position: relative !important;
    z-index: 10 !important;
}

.nav-button {
    padding: 0.75rem 1.5rem !important;
    background: rgba(255, 255, 255, 0.9) !important;
    border: none !important;
    border-radius: 25px !important;
    color: #2c3e50 !important;
    text-decoration: none !important;
    font-weight: 600 !important;
    transition: all 0.3s ease !important;
    cursor: pointer !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
}

.nav-button:hover, .nav-button.active {
    background: #3498db !important;
    color: white !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3) !important;
}

        .assignments-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 2rem;
            height: calc(100vh - 200px);
        }

        .requests-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .assignments-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .panel-title {
            font-size: 1.3rem;
            color: #2c3e50;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .request-item {
            padding: 1rem;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .request-item:hover {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.05);
        }

        .request-item.selected {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.1);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.2);
        }

        .request-id {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .request-details {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 0.5rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 0.5rem;
            display: inline-block;
        }

        .status-new { background: #fff3cd; color: #856404; }
        .status-pending { background: #d4edda; color: #155724; }
        .status-assigned { background: #cce5ff; color: #004085; }
        .status-unassigned { background: #ffeaa7; color: #b45f06; }

        .assignment-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .request-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-weight: 600;
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .info-value {
            color: #2c3e50;
            font-size: 1rem;
        }

        .riders-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .riders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
            padding-right: 10px;
        }

        .rider-card {
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            padding: 1rem;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .rider-card:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.2);
        }

        .rider-card.selected {
            border-color: #27ae60;
            background: rgba(39, 174, 96, 0.05);
        }

        .rider-card.unavailable {
            opacity: 0.6;
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.05);
        }

        .rider-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .rider-info {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 0.25rem;
        }

        .rider-status {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-available { background: #27ae60; }
        .status-busy { background: #f39c12; }
        .status-unavailable { background: #e74c3c; }

        .assignment-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid #ecf0f1;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #229954);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #7f8c8d;
        }

        .assignment-summary {
            background: #e8f5e8;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #27ae60;
        }

        .current-assigned {
            background: #fff8e1;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #f39c12;
        }

        .current-assigned ul {
            margin: 0;
            padding-left: 1.2rem;
        }

        .current-assigned li {
            margin-bottom: 0.25rem;
        }

        .selected-count {
            font-weight: bold;
            color: #27ae60;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
        }

        .search-box {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ecf0f1;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease;
            margin-bottom: 1rem;
        }

        .search-box:focus {
            border-color: #3498db;
        }

        .filter-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .filter-tab {
            padding: 0.5rem 1rem;
            border: 2px solid #ecf0f1;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .filter-tab.active {
            border-color: #3498db;
            background: #3498db;
            color: white;
        }

        @media (max-width: 1024px) {
            .assignments-layout {
                grid-template-columns: 1fr;
                height: auto;
            }

            .requests-panel {
                order: 2;
                max-height: 300px;
            }

            .assignments-panel {
                order: 1;
            }

            .riders-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .riders-grid {
                grid-template-columns: 1fr;
            }

            .assignment-actions {
                flex-direction: column;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.4rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>üèçÔ∏è Motorcycle Escort Management</h1>
        
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">?</div>
            <div class="user-details">
                <div class="user-name" id="userName">Loading...</div>
                <div class="user-role" id="userRole">User</div>
            </div>
        </div>
    </header>

    <!--NAVIGATION_MENU_PLACEHOLDER-->

    <div class="container">
        <div class="assignments-layout">
            <!-- Requests Panel -->
            <div class="requests-panel">
                <h3 class="panel-title">üìã Available Requests</h3>
                
                <input type="text" class="search-box" placeholder="üîç Search requests..." id="requestSearch">
                
                <div class="filter-tabs">
                    <div class="filter-tab active" data-status="all">All</div>
                    <div class="filter-tab" data-status="New">New</div>
                    <div class="filter-tab" data-status="Unassigned">Unassigned</div>
                    <div class="filter-tab" data-status="Assigned">Assigned</div>
                </div>

                <div id="requestsList">
                    <div class="loading">Loading requests...</div>
                </div>
            </div>

            <!-- Assignment Panel -->
            <div class="assignments-panel">
                <h3 class="panel-title">üèçÔ∏è Rider Assignment</h3>
                
                <div id="assignmentContent" class="assignment-content">
                    <div class="empty-state">
                        <h3>Select a Request</h3>
                        <p>Choose a request from the left panel to begin assigning riders</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    /**
     * @typedef {object} UserProfile - (Assuming type definition from index.html or similar)
     * @property {string} name
     * @property {string} email
     * @property {Array<string>} roles
     * @property {Array<string>} permissions
     */

    /**
     * @typedef {object} RequestItemAssignmentsPage - Data for a request in the assignments list.
     * @property {string} id - The request ID.
     * @property {string} requesterName - Name of the requester.
     * @property {string} eventDate - Formatted event date.
     * @property {string} startTime - Formatted start time.
     * @property {string} startLocation - Start location.
     * @property {number} ridersNeeded - Number of riders needed.
     * @property {string} status - Current status of the request.
     * @property {string} [type] - Type of request.
     * @property {string} [endTime] - Formatted end time.
     * @property {string} [endLocation] - End location.
     * @property {string} [ridersAssigned] - Comma-separated string of assigned rider names.
     */

    /**
     * @typedef {object} RiderItemAssignmentsPage - Data for an active rider.
     * @property {string} name - Rider's full name.
     * @property {string} jpNumber - Rider's JP Number or ID.
     * @property {string} phone - Rider's phone number.
     * @property {string} email - Rider's email address.
     * @property {string} carrier - Rider's phone carrier.
     * @property {string} [status] - Rider's current status (e.g., "Available").
     */

    /**
     * @typedef {object} AppStateAssignments
     * @property {UserProfile|null} user - Current user's profile.
     * @property {boolean} isOnline - Network status.
     * @property {number} loadingTimeout - Timeout for loading operations in milliseconds.
     */

    /** Global state for the assignments page. */
    var currentRequests = [];
    /** @type {Array<RiderItemAssignmentsPage>} */
    var activeRiders = [];
    /** @type {RequestItemAssignmentsPage|null} */
    var selectedRequest = null;
    /** @type {Set<string>} */
    var selectedRiders = new Set(); // Stores names of selected riders
    /** Map of rider name to availability status */
    var riderAvailability = {}; // e.g., {"John Doe": "Busy"}
    /** @type {AppStateAssignments} */
    var app = {
        user: null,
        isOnline: navigator.onLine,
        loadingTimeout: 15000,
        dateFilter: 'all'
    };

    /**
     * Initializes the assignments page when the DOM content is fully loaded.
     * Sets a timeout for data loading and fetches initial data.
     * Also checks for a requestId in the URL to pre-select a request.
     * @listens DOMContentLoaded
     */
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Assignments page loading...');

        const params = new URLSearchParams(window.location.search);
        const dateParam = params.get('date');
        if (dateParam) {
            app.dateFilter = dateParam.toLowerCase();
        }

        setTimeout(function() {
            if (currentRequests.length === 0 && activeRiders.length === 0) {
                console.log('‚ö†Ô∏è Loading timeout - showing fallback data');
                handleLoadingTimeout();
            }
        }, app.loadingTimeout);

        loadAllData();
        setupEventListeners();

        // Pre-selection of request is now handled within handleAssignmentsDataSuccess
    });

    /**
     * Loads all necessary data for the assignments page by calling the consolidated
     * server-side function `getPageDataForAssignments`.
     * Passes a requestId from URL parameters if present.
     * @return {void}
     */
    function loadAllData() {
        console.log('üìä Starting consolidated data loading for assignments page...');
        var urlParams = new URLSearchParams(window.location.search);
        var requestIdToLoad = urlParams.get('requestId');

        if (typeof google !== 'undefined' && google.script && google.script.run) {
            google.script.run
                .withSuccessHandler(handleAssignmentsDataSuccess)
                .withFailureHandler(handleAssignmentsDataFailure)
                .getPageDataForAssignments(requestIdToLoad);
        } else {
            console.log('‚ö†Ô∏è Google Apps Script not available for assignments page.');
            handleAssignmentsDataFailure({ message: "Google Apps Script not available." });
        }
    }
<!-- Add this to your assignments.html <script> section for debugging -->

// Debug function to test riders loading
function debugRidersLoading() {
  console.log('üîç Debugging riders loading...');
  
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    // Test the enhanced function
    console.log('üìû Calling debugActiveRidersIssue...');
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('‚úÖ Debug result:', result);
        
        if (result.error) {
          console.error('‚ùå Server-side error:', result.error);
        } else {
          console.log(`üìä Found ${result.ridersFound} total riders, ${result.activeRiders} active`);
          console.log('üìã Headers:', result.headers);
          console.log('üìÑ Sample data:', result.sampleData);
        }
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå Debug call failed:', error);
      })
      .debugActiveRidersIssue();
      
    // Also test the regular function
    console.log('üìû Calling getActiveRidersForAssignments...');
    google.script.run
      .withSuccessHandler(function(riders) {
        console.log('‚úÖ Active riders result:', riders);
        console.log(`üìä Found ${riders.length} active riders`);
        
        if (riders.length > 0) {
          console.log('üë§ Sample rider:', riders[0]);
        } else {
          console.log('‚ùå No active riders found');
        }
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå Active riders call failed:', error);
      })
      .getActiveRidersForAssignments();
      
  } else {
    console.error('‚ùå Google Apps Script not available');
  }
}

// Enhanced riders loading with better error handling
function loadActiveRidersEnhanced() {
  console.log('üîÑ Loading active riders with enhanced debugging...');
  
  showLoading('Loading riders...');
  
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(function(riders) {
        hideLoading();
        console.log('‚úÖ Enhanced riders loaded:', riders);
        
        if (!riders || !Array.isArray(riders)) {
          console.error('‚ùå Invalid riders data received:', typeof riders);
          displayNoRiders('Invalid data received from server');
          return;
        }
        
        if (riders.length === 0) {
          console.log('‚ö†Ô∏è No active riders found');
          
          // Try the flexible function as fallback
          console.log('üîÑ Trying flexible function as fallback...');
          google.script.run
            .withSuccessHandler(function(flexibleRiders) {
              console.log('üîÑ Flexible function result:', flexibleRiders);
              
              if (flexibleRiders && flexibleRiders.length > 0) {
                displayRiders(flexibleRiders);
                showSuccess(`Found ${flexibleRiders.length} riders using flexible detection`);
              } else {
                displayNoRiders('No active riders found in system');
              }
            })
            .withFailureHandler(function(error) {
              console.error('‚ùå Flexible function failed:', error);
              displayNoRiders('Error loading riders: ' + error.message);
            })
            .getActiveRidersForAssignmentsFlexible();
            
        } else {
          displayRiders(riders);
          showSuccess(`Loaded ${riders.length} active riders`);
        }
      })
      .withFailureHandler(function(error) {
        hideLoading();
        console.error('‚ùå Enhanced riders loading failed:', error);
        displayNoRiders('Error loading riders: ' + (error.message || error));
      })
      .getActiveRidersForAssignments();
  } else {
    hideLoading();
    console.error('‚ùå Google Apps Script not available');
    displayNoRiders('Google Apps Script not available');
  }
}

// Display no riders message with more info
function displayNoRiders(message) {
  const ridersContainer = document.getElementById('ridersContainer') || 
                         document.querySelector('.riders-list') ||
                         document.querySelector('#activeRidersList');
  
  if (ridersContainer) {
    ridersContainer.innerHTML = `
      <div class="no-riders-message">
        <h3>‚ö†Ô∏è No Active Riders Available</h3>
        <p>${message}</p>
        <div class="debug-actions">
          <button onclick="debugRidersLoading()" class="btn btn-info">
            üîç Debug Riders Loading
          </button>
          <button onclick="loadActiveRidersEnhanced()" class="btn btn-primary">
            üîÑ Retry Loading
          </button>
          <button onclick="window.open('?page=riders', '_blank')" class="btn btn-secondary">
            üë• Go to Riders Page
          </button>
        </div>
        <details class="debug-info">
          <summary>üîß Technical Details</summary>
          <ul>
            <li>This usually means no riders have "Active" status</li>
            <li>Check the Riders sheet for proper data</li>
            <li>Verify column headers match the configuration</li>
            <li>Ensure riders have names and status values</li>
          </ul>
        </details>
      </div>
    `;
  }
}

// Better success/error notifications
function showSuccess(message) {
  console.log('‚úÖ', message);
  // Add your success notification code here
}

function showError(message) {
  console.error('‚ùå', message);
  // Add your error notification code here
}

function showLoading(message) {
  console.log('üîÑ', message);
  // Add your loading indicator code here
}

function hideLoading() {
  console.log('‚úÖ Loading complete');
  // Add your hide loading code here
}

// Auto-run debug when page loads (temporary)
document.addEventListener('DOMContentLoaded', function() {
  // Wait a bit for the page to fully load
  setTimeout(function() {
    console.log('üîç Auto-running riders debug...');
    debugRidersLoading();
  }, 2000);
});

// Add CSS for the no-riders message
const debugStyles = `
<style>
.no-riders-message {
  text-align: center;
  padding: 2rem;
  background: #f8f9fa;
  border-radius: 8px;
  border: 1px solid #dee2e6;
  margin: 1rem 0;
}

.no-riders-message h3 {
  color: #dc3545;
  margin-bottom: 1rem;
}

.debug-actions {
  margin: 1.5rem 0;
  display: flex;
  gap: 0.5rem;
  justify-content: center;
  flex-wrap: wrap;
}

.debug-actions .btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  text-decoration: none;
  display: inline-block;
}

.btn-info { background: #17a2b8; color: white; }
.btn-primary { background: #007bff; color: white; }
.btn-secondary { background: #6c757d; color: white; }

.debug-info {
  text-align: left;
  margin-top: 1rem;
  padding: 1rem;
  background: white;
  border-radius: 4px;
  border: 1px solid #dee2e6;
}

.debug-info summary {
  cursor: pointer;
  font-weight: bold;
  margin-bottom: 0.5rem;
}

.debug-info ul {
  margin: 0.5rem 0 0 1rem;
}

.debug-info li {
  margin: 0.25rem 0;
  color: #6c757d;
}
</style>
`;

// Add debug styles to document
if (!document.getElementById('debug-styles')) {
  const styleDiv = document.createElement('div');
  styleDiv.id = 'debug-styles';
  styleDiv.innerHTML = debugStyles;
  document.head.appendChild(styleDiv);
}
    /**
     * Handles the successful response from fetching consolidated assignments page data.
     * Updates UI with user info, requests, riders, and potentially pre-selects a request.
     * @param {object} data - The consolidated data object from the server.
     * @param {boolean} data.success - Indicates if the server call was successful.
     * @param {UserProfile} [data.user] - User information.
     * @param {Array<RequestItemAssignmentsPage>} [data.requests] - Assignable requests.
     * @param {Array<RiderItemAssignmentsPage>} [data.riders] - Active riders.
     * @param {RequestItemAssignmentsPage} [data.initialRequestDetails] - Details if a specific request was pre-loaded.
     * @param {string} [data.error] - Error message if success is false.
     * @return {void}
     */
    function handleAssignmentsDataSuccess(data) {
        if (data && data.success) {
            console.log('‚úÖ Assignments page data loaded successfully:', data);
            handleUserData(data.user);
            handleRequestsLoaded(data.requests);
            handleRidersLoaded(data.riders);

            if (data.initialRequestDetails) {
                setTimeout(function() {
                     const preloadedRequestId = data.initialRequestDetails.id || data.initialRequestDetails.requestId;
                     if (preloadedRequestId) {
                        console.log('Attempting to pre-select request:', preloadedRequestId);
                        selectRequest(preloadedRequestId, true);
                     }
                }, 500);
            } else {
                 var urlParams = new URLSearchParams(window.location.search);
                 var requestIdFromUrl = urlParams.get('requestId');
                 if (requestIdFromUrl) {
                     console.log('Attempting to select request from URL param (fallback):', requestIdFromUrl);
                     setTimeout(function() { selectRequest(requestIdFromUrl, true); }, 500);
                 }
            }
        } else {
            console.error('‚ùå Failed to load assignments page data:', data ? data.error : 'No data returned');
            handleAssignmentsDataFailure(data || { message: "Received success:false or no data." });
        }
    }

    /**
     * Handles failures in fetching consolidated assignments page data.
     * Logs the error and attempts to set fallback UI states.
     * @param {object|string} error - The error object or message.
     * @param {UserProfile} [error.user] - User data if available.
     * @return {void}
     */
    function handleAssignmentsDataFailure(error) {
        console.error('‚ùå Error loading assignments page data:', error.message || error);
        const fallbackUser = (error && error.user) ? error.user : {
            name: 'System User',
            email: 'user@system.com',
            roles: ['admin'],
            permissions: ['view', 'create_request', 'assign_riders', 'send_notifications', 'view_reports']
        };
        handleUserData(fallbackUser);
        handleLoadingTimeout();
    }

    /**
     * Updates the user interface with the provided user data (name, role, avatar).
     * Also adjusts navigation link visibility based on permissions.
     * @param {UserProfile} user - The user object.
     * @return {void}
     */
    function handleUserData(user) {
        console.log('üë§ User data loaded:', user);
        app.user = user;

        document.getElementById('userName').textContent = user.name || 'User';
        document.getElementById('userRole').textContent = (user.roles || ['user']).join(', ');
        document.getElementById('userAvatar').textContent = (user.name || 'U').charAt(0).toUpperCase();

        var permissions = user.permissions || [];

        if (permissions.indexOf('send_notifications') === -1) {
            var notifLink = document.getElementById('notificationsLink');
            if (notifLink) notifLink.style.display = 'none';
        }
        if (permissions.indexOf('view_reports') === -1) {
            var reportsLink = document.getElementById('reportsLink');
            if (reportsLink) reportsLink.style.display = 'none';
        }
    }

    /**
     * Processes the loaded requests data and stores it. Renders the requests list.
     * @param {Array<RequestItemAssignmentsPage>|null|undefined} data - Array of request items.
     * @return {void}
     */
    function handleRequestsLoaded(data) {
        console.log('üìã Processing loaded requests:', data);

        if (data === null || data === undefined) {
            console.log('‚ö†Ô∏è Server returned null/undefined for requests');
            data = [];
        }

        currentRequests = Array.isArray(data) ? data : [];
        currentRequests.sort(function(a, b) {
            var dateA = new Date(a.eventDate);
            var dateB = new Date(b.eventDate);
            if (isNaN(dateA.getTime()) && isNaN(dateB.getTime())) return 0;
            if (isNaN(dateA.getTime())) return 1;
            if (isNaN(dateB.getTime())) return -1;
            return dateA.getTime() - dateB.getTime();
        });
        console.log('üìä Stored requests count:', currentRequests.length);

        filterRequests();
    }

    /**
     * Processes the loaded active riders data and stores it.
     * @param {Array<RiderItemAssignmentsPage>|null|undefined} data - Array of rider items.
     * @return {void}
     */
    function handleRidersLoaded(data) {
        console.log('üèçÔ∏è Processing loaded riders:', data);

        if (data === null || data === undefined) {
            console.log('‚ö†Ô∏è Server returned null/undefined for riders');
            data = [];
        }

        activeRiders = Array.isArray(data) ? data : [];
        console.log('üìä Stored riders count:', activeRiders.length);
    }

    /**
     * Renders the list of assignable requests in the left panel.
     * Filters `currentRequests` to show only those with assignable statuses.
     * @return {void}
     */
    function renderRequestsList() {
        var container = document.getElementById('requestsList');

        if (!container) {
            console.error('‚ùå Requests list container not found');
            return;
        }

        if (currentRequests.length === 0) {
            container.innerHTML = '<div class="empty-state"><h3>No assignable requests found</h3><p>Create new requests or check if existing requests have assignable statuses</p></div>';
            return;
        }

        var assignableRequests = currentRequests.filter(function(request) {
            return ['New', 'Pending', 'Assigned', 'Unassigned'].indexOf(request.status) !== -1;
        });

        if (assignableRequests.length === 0) {
            container.innerHTML = '<div class="empty-state"><h3>No assignable requests</h3><p>All requests have been completed or cancelled</p></div>';
            return;
        }

        var html = assignableRequests.map(function(request) {
            return '<div class="request-item" data-request-id="' + request.id + '" onclick="selectRequest(\'' + request.id + '\')">' +
                '<div class="request-id">' + request.id + '</div>' +
                '<div class="request-details">' +
                '<strong>' + request.requesterName + '</strong><br>' +
                request.eventDate + ' at ' + request.startTime + '<br>' +
                'üìç ' + request.startLocation + '<br>' +
                'üë• ' + request.ridersNeeded + ' rider(s) needed' +
                '</div>' +
                '<span class="status-badge status-' + request.status.toLowerCase() + '">' +
                request.status +
                '</span>' +
                '</div>';
        }).join('');

        container.innerHTML = html;
        console.log('‚úÖ Rendered', assignableRequests.length, 'assignable requests');
    }

    /**
     * Sets up event listeners for the request search input and filter tabs.
     * @return {void}
     */
    function setupEventListeners() {
        var searchInput = document.getElementById('requestSearch');
        if (searchInput) {
            searchInput.addEventListener('input', filterRequests);
        }

        var filterTabs = document.querySelectorAll('.filter-tab');
        for (var i = 0; i < filterTabs.length; i++) {
            filterTabs[i].addEventListener('click', function(e) {
                var allTabs = document.querySelectorAll('.filter-tab');
                for (var j = 0; j < allTabs.length; j++) {
                    allTabs[j].classList.remove('active');
                }
                e.target.classList.add('active');
                filterRequests();
            });
        }
    }

    /**
     * Filters the displayed list of requests based on search term and active status tab.
     * @return {void}
     */
    function filterRequests() {
        var searchInput = document.getElementById('requestSearch');
        var searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        var activeTab = document.querySelector('.filter-tab.active');
        var activeStatus = activeTab ? activeTab.dataset.status : 'all';

        var filtered = currentRequests.filter(function(request) {
            var matchesSearch = !searchTerm ||
                request.id.toLowerCase().indexOf(searchTerm) !== -1 ||
                request.requesterName.toLowerCase().indexOf(searchTerm) !== -1;

            var matchesStatus = activeStatus === 'all' || request.status === activeStatus;

            var matchesDate = true;
            if (app.dateFilter === 'today') {
                var today = new Date().toISOString().slice(0, 10);
                matchesDate = request.eventDate === today;
            } else if (app.dateFilter === 'week') {
                try {
                    var reqDate = new Date(request.eventDate);
                    var now = new Date();
                    var start = new Date(now);
                    start.setDate(now.getDate() - now.getDay());
                    start.setHours(0,0,0,0);
                    var end = new Date(start);
                    end.setDate(start.getDate() + 6);
                    matchesDate = reqDate >= start && reqDate <= end;
                } catch (e) {
                    matchesDate = true;
                }
            }

            return matchesSearch && matchesStatus && matchesDate && ['New', 'Pending', 'Assigned', 'Unassigned'].indexOf(request.status) !== -1;
        });

        renderFilteredRequests(filtered);
    }
    /**
     * Renders a list of requests that have been filtered.
     * @param {Array<RequestItemAssignmentsPage>} requests - The array of request items to render.
     * @return {void}
     */
    function renderFilteredRequests(requests) {
        var container = document.getElementById('requestsList');

        if (!container) return;

        if (requests.length === 0) {
            container.innerHTML = '<div class="empty-state"><h3>No matching requests</h3><p>Try adjusting your search or filter</p></div>';
            return;
        }

        var html = requests.map(function(request) {
            return '<div class="request-item" data-request-id="' + request.id + '" onclick="selectRequest(\'' + request.id + '\')">' +
                '<div class="request-id">' + request.id + '</div>' +
                '<div class="request-details">' +
                '<strong>' + request.requesterName + '</strong><br>' +
                request.eventDate + ' at ' + request.startTime + '<br>' +
                'üìç ' + request.startLocation + '<br>' +
                'üë• ' + request.ridersNeeded + ' rider(s) needed' +
                '</div>' +
                '<span class="status-badge status-' + request.status.toLowerCase() + '">' +
                request.status +
                '</span>' +
                '</div>';
        }).join('');

        container.innerHTML = html;
    }

    /**
     * Handles the selection of a request from the list.
     * Updates the UI to show details for the selected request and renders the rider assignment panel.
     * @param {string} requestId - The ID of the request to select.
     * @param {boolean} [isPreselection=false] - Flag indicating if this is a pre-selection (e.g., from URL).
     * @return {void}
     */
    function selectRequest(requestId) {
        console.log('üéØ Selecting request:', requestId);

        var requestItems = document.querySelectorAll('.request-item');
        for (var i = 0; i < requestItems.length; i++) {
            requestItems[i].classList.remove('selected');
        }

        var requestElement = document.querySelector('[data-request-id="' + requestId + '"]');
        if (requestElement) {
            requestElement.classList.add('selected');
        }

        selectedRequest = null;
        for (var j = 0; j < currentRequests.length; j++) {
            if (currentRequests[j].id === requestId) {
                selectedRequest = currentRequests[j];
                break;
            }
        }

        selectedRiders.clear();

        if (selectedRequest) {
            console.log('‚úÖ Selected request:', selectedRequest);
            renderAssignmentPanel();
        } else {
            console.error('‚ùå Request not found:', requestId);
            // If it was a pre-selection that failed, show a message.
            // if (isPreselection) {
            //     showError(`Could not automatically select request ID: ${requestId}. It might not be in the current list of assignable requests.`);
            // }
        }
    }

    /**
     * Attempts to select a request by its ID. Used for pre-selection from URL parameters.
     * @param {string} requestId - The ID of the request to select.
     * @return {void}
     * @deprecated This function seems redundant if selectRequest handles finding the request.
     *             The pre-selection logic is now mostly within handleAssignmentsDataSuccess.
     */
    function selectRequestById(requestId) {
        var request = null;
        for (var i = 0; i < currentRequests.length; i++) {
            if (currentRequests[i].id === requestId) {
                request = currentRequests[i];
                break;
            }
        }
        if (request) {
            selectRequest(requestId);
        } else {
            console.log('‚ö†Ô∏è Request ID not found in current requests:', requestId);
        }
    }

    /**
     * Renders the main assignment panel for the currently `selectedRequest`.
     * Displays request details and the grid of available riders.
     * @return {void}
     */
    function renderAssignmentPanel() {
        var container = document.getElementById('assignmentContent');

        if (!selectedRequest) {
            container.innerHTML = '<div class="empty-state"><h3>Select a Request</h3><p>Choose a request from the left panel to begin assigning riders</p></div>';
            return;
        }

        var assignedRidersArray = selectedRequest.ridersAssigned ?
            selectedRequest.ridersAssigned.split(/[,\n]/).map(function(name) { return name.trim(); }).filter(function(name) { return name.length > 0; }) : [];

        selectedRiders.clear();
        for (var i = 0; i < assignedRidersArray.length; i++) {
            selectedRiders.add(assignedRidersArray[i]);
        }

        container.innerHTML = '<div class="request-info">' +
            '<h4>' + selectedRequest.id + ' - ' + selectedRequest.requesterName + '</h4>' +
            '<div class="info-grid">' +
            '<div class="info-item">' +
            '<div class="info-label">Event Date & Time</div>' +
            '<div class="info-value">' + selectedRequest.eventDate + ' at ' + selectedRequest.startTime + '</div>' +
            '</div>' +
            '<div class="info-item">' +
            '<div class="info-label">Type</div>' +
            '<div class="info-value">' + selectedRequest.type + '</div>' +
            '</div>' +
            '<div class="info-item">' +
            '<div class="info-label">Start Location</div>' +
            '<div class="info-value">' + selectedRequest.startLocation + '</div>' +
            '</div>' +
            '<div class="info-item">' +
            '<div class="info-label">End Location</div>' +
            '<div class="info-value">' + selectedRequest.endLocation + '</div>' +
            '</div>' +
            '<div class="info-item">' +
            '<div class="info-label">Riders Needed</div>' +
            '<div class="info-value">' + selectedRequest.ridersNeeded + '</div>' +
            '</div>' +
            '<div class="info-item">' +
            '<div class="info-label">Current Status</div>' +
            '<div class="info-value">' +
            '<span class="status-badge status-' + selectedRequest.status.toLowerCase() + '">' +
            selectedRequest.status +
            '</span>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '<div class="current-assigned">' +
            '<h4>Currently Assigned Riders</h4>' +
            '<ul>' +
            (assignedRidersArray.length === 0 ? '<li>None</li>' : assignedRidersArray.map(function(n){ return '<li>' + n + '</li>'; }).join('')) +
            '</ul>' +
            '</div>' +
            '<div class="assignment-summary">' +
            '<div>Selected Riders: <span class="selected-count" id="selectedCount">' + selectedRiders.size + '</span> / ' + selectedRequest.ridersNeeded + '</div>' +
            '</div>' +
            '<div class="riders-section">' +
            '<h4>Available Riders</h4>' +
            '<div class="riders-grid" id="ridersGrid">' +
            renderRidersGrid() +
            '</div>' +
            '</div>' +
            '<div class="assignment-actions">' +
            '<button class="btn btn-success" onclick="saveAssignment()" ' + (selectedRiders.size === 0 ? 'disabled' : '') + '>' +
            'üíæ Save Assignment' +
            '</button>' +
            '<button class="btn btn-warning" onclick="clearAssignment()">' +
            'üóëÔ∏è Clear All' +
            '</button>' +
            '<button class="btn btn-primary" onclick="previewAssignment()">' +
            'üëÅÔ∏è Preview' +
            '</button>' +
            '</div>';

        updateSelectedCount();
        fetchRiderAvailabilityForRequest();
    }

    /**
     * Renders the grid of available riders.
     * Each rider is displayed as a card that can be selected/deselected.
     * @return {string} HTML string for the riders grid.
     */
    function renderRidersGrid() {
        if (activeRiders.length === 0) {
            return '<div class="empty-state"><h3>No active riders</h3><p>No riders available for assignment</p></div>';
        }

        return activeRiders.map(function(rider) {
            var isSelected = selectedRiders.has(rider.name);
            var availability = riderAvailability[rider.name] || 'Available';
            var isUnavailable = availability !== 'Available';

            return '<div class="rider-card ' + (isSelected ? 'selected' : '') + ' ' + (isUnavailable ? 'unavailable' : '') + '" data-rider-name="' + rider.name.replace(/"/g,'&quot;') + '" onclick="toggleRider(\'' + rider.name + '\')">' +
                '<div class="rider-status status-' + availability.toLowerCase() + '"></div>' +
                '<div class="rider-name">' + rider.name + '</div>' +
                '<div class="rider-info">ID: ' + rider.jpNumber + '</div>' +
                '<div class="rider-info">üìû ' + rider.phone + '</div>' +
                '<div class="rider-info">üìß ' + rider.email + '</div>' +
                '<div class="rider-info">üì° ' + rider.carrier + '</div>' +
                (isUnavailable ? '<div class="rider-info conflict-info" style="color: #e74c3c; font-weight: bold;">‚ö†Ô∏è ' + availability + '</div>' : '') +
                '</div>';
        }).join('');
    }

    /**
     * Determines rider availability for a given request. (Placeholder implementation)
     * @param {RiderItemAssignmentsPage} rider - The rider object.
     * @param {RequestItemAssignmentsPage} request - The request object.
     * @return {string} Availability status (e.g., "Available", "Busy", "Unavailable"). Currently always "Available".
     */
    function getRiderAvailability(rider, request) {
        if (!rider || !rider.name) return 'Available';
        return riderAvailability[rider.name] || 'Available';
    }

    /**
     * Toggles the selection state of a rider.
     * Adds or removes the rider's name from the `selectedRiders` set.
     * Updates the UI to reflect the change.
     * @param {string} riderName - The name of the rider to toggle.
     * @return {void}
     */
    function toggleRider(riderName) {
        if (selectedRiders.has(riderName)) {
            selectedRiders.delete(riderName);
        } else {
            selectedRiders.add(riderName);
        }

        updateRiderSelection();
        updateSelectedCount();
    }

    /**
     * Updates the visual selection state (CSS class) of rider cards in the grid.
     * @return {void}
     */
    function updateRiderSelection() {
        var riderCards = document.querySelectorAll('.rider-card');
        for (var i = 0; i < riderCards.length; i++) {
            var card = riderCards[i];
            var riderName = card.querySelector('.rider-name').textContent;
            if (selectedRiders.has(riderName)) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        }
    }

    /**
     * Updates the displayed count of selected riders and enables/disables the save button.
     * @return {void}
     */
    function updateSelectedCount() {
        var countElement = document.getElementById('selectedCount');
        if (countElement) {
            countElement.textContent = selectedRiders.size;
        }

        var saveBtn = document.querySelector('.btn-success');
        if (saveBtn) {
            saveBtn.disabled = selectedRiders.size === 0;
            saveBtn.style.opacity = selectedRiders.size === 0 ? '0.5' : '1';
        }
    }

    /**
     * Fetch availability/conflict status for each rider for the selected request.
     * Updates riderAvailability map and the UI accordingly.
     * @return {void}
     */
    function fetchRiderAvailabilityForRequest() {
        if (!selectedRequest) return;

        riderAvailability = {};

        activeRiders.forEach(function(rider) {
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(function(conflict) {
                        riderAvailability[rider.name] = conflict ? 'Busy' : 'Available';
                        updateSingleRiderAvailability(rider.name);
                    })
                    .withFailureHandler(function(err) {
                        console.error('Availability check failed for', rider.name, err);
                    })
                    .checkRiderTimeConflict(rider.name, selectedRequest.eventDate, selectedRequest.startTime);
            }
        });
    }

    /**
     * Update the UI status for a single rider card based on riderAvailability map.
     * @param {string} riderName
     */
    function updateSingleRiderAvailability(riderName) {
        var availability = riderAvailability[riderName] || 'Available';
        var card = document.querySelector('.rider-card[data-rider-name="' + riderName.replace(/"/g,'\\"') + '"]');
        if (!card) return;
        var statusDiv = card.querySelector('.rider-status');

        card.classList.toggle('unavailable', availability !== 'Available');

        if (statusDiv) {
            statusDiv.classList.remove('status-available', 'status-busy', 'status-unavailable');
            statusDiv.classList.add('status-' + availability.toLowerCase());
        }

        var info = card.querySelector('.conflict-info');
        if (availability !== 'Available') {
            if (!info) {
                info = document.createElement('div');
                info.className = 'rider-info conflict-info';
                info.style.color = '#e74c3c';
                info.style.fontWeight = 'bold';
                card.appendChild(info);
            }
            info.textContent = '‚ö†Ô∏è ' + availability;
        } else if (info) {
            info.remove();
        }
    }

    /**
     * Saves the current rider assignments for the selected request to the server.
     * Calls the `processAssignmentAndPopulate` server-side function.
     * @return {void}
     */
    function saveAssignment() {
        if (!selectedRequest || selectedRiders.size === 0) {
            showError('Please select at least one rider');
            return;
        }

        var ridersArray = [];
        selectedRiders.forEach(function(name) {
            var rider = null;
            for (var i = 0; i < activeRiders.length; i++) {
                if (activeRiders[i].name === name) {
                    rider = activeRiders[i];
                    break;
                }
            }
            ridersArray.push({ // Push full rider object if found, or just name if not (should always be found)
                name: rider ? rider.name : name,
                jpNumber: rider ? rider.jpNumber : '',
                phone: rider ? rider.phone : '',
                email: rider ? rider.email : '',
                carrier: rider ? rider.carrier : ''
            });
        });

        showLoading('Saving assignment...');

        try {
            google.script.run
                .withSuccessHandler(handleAssignmentSuccess)
                .withFailureHandler(handleError) // Generic error handler
                .processAssignmentAndPopulate(selectedRequest.id, ridersArray);
        } catch (error) {
            console.error('Error calling processAssignmentAndPopulate:', error);
            hideLoading();
            showError('Failed to save assignment: ' + error.message);
        }
    }

    /**
     * Handles the successful response from saving an assignment.
     * Shows a success message and reloads the requests list to reflect changes.
     * @param {object} response - The response object from the server.
     * @param {boolean} response.success - Indicates if the operation was successful.
     * @param {string} [response.message] - Optional message from the server.
     * @return {void}
     */
    function handleAssignmentSuccess(response) {
        hideLoading();

        if (response && response.success) {
            showSuccess('Assignment saved successfully!');
            
            // Reload data for the current page to reflect status changes, etc.
            // This now uses the consolidated data loader.
            setTimeout(function() {
                loadAllData(); // This will re-fetch user, requests, and riders.
                // If selectedRequest.id was valid, it will attempt to re-select it via URL param logic in loadAllData.
            }, 1000);
        } else {
            showError(response ? response.message : 'Failed to save assignment');
        }
    }

    /**
     * Clears all currently selected riders for the active request.
     * Asks for confirmation before clearing.
     * @return {void}
     */
    function clearAssignment() {
        if (confirm('Clear all rider assignments for this request?')) {
            selectedRiders.clear();
            updateRiderSelection();
            updateSelectedCount();
        }
    }

    /**
     * Shows an alert with a preview of the current assignment details.
     * @return {void}
     */
    function previewAssignment() {
        if (selectedRiders.size === 0) {
            alert('No riders selected for preview');
            return;
        }

        var ridersList = [];
        selectedRiders.forEach(function(rider) {
            ridersList.push(rider);
        });

        alert('Assignment Preview:\n\nRequest: ' + selectedRequest.id + '\nRequester: ' + selectedRequest.requesterName + '\nEvent: ' + selectedRequest.eventDate + ' at ' + selectedRequest.startTime + '\n\nAssigned Riders (' + selectedRiders.size + '):\n' + ridersList.join('\n'));
    }

    /**
     * Handles data loading timeouts by displaying an error message and
     * showing a refresh button in the requests list area.
     * @return {void}
     */
    function handleLoadingTimeout() {
        console.log('‚ö†Ô∏è Handling loading timeout...');

        var requestsContainer = document.getElementById('requestsList');
        if (requestsContainer) {
            requestsContainer.innerHTML = '<div class="empty-state"><h3>Loading Error</h3><p>Unable to load requests. Please try refreshing the page.</p><button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3498db; color: white; border: none; border-radius: 5px;">üîÑ Refresh Page</button></div>';
        }

        var assignmentPanel = document.getElementById('assignmentContent');
        if (assignmentPanel.innerHTML.includes('Select a Request')) { // Only if not already displaying a request
             assignmentPanel.innerHTML = '<div class="empty-state"><h3>Loading Error</h3><p>Please refresh the page.</p></div>';
        }

        showError('Failed to load assignments data. Please check your connection and try again.');
    }

    /**
     * Displays a loading overlay with a message.
     * @param {string} [message='Loading...'] - The message to display.
     * @return {void}
     */
    function showLoading(message) {
        var loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading'; // Use class for styling if defined
        loadingDiv.textContent = message || 'Loading...';
        loadingDiv.style.position = 'fixed';
        loadingDiv.style.top = '50%';
        loadingDiv.style.left = '50%';
        loadingDiv.style.transform = 'translate(-50%, -50%)';
        loadingDiv.style.background = 'rgba(255, 255, 255, 0.95)';
        loadingDiv.style.padding = '2rem';
        loadingDiv.style.borderRadius = '10px';
        loadingDiv.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.3)';
        loadingDiv.style.zIndex = '9999';
        loadingDiv.id = 'loading-overlay';

        document.body.appendChild(loadingDiv);
    }

    /**
     * Hides the loading overlay.
     * @return {void}
     */
    function hideLoading() {
        var loading = document.getElementById('loading-overlay');
        if (loading) loading.remove();
    }

    /**
     * Displays a success notification message.
     * @param {string} message - The success message.
     * @return {void}
     */
    function showSuccess(message) {
        showNotification(message, '#27ae60');
    }

    /**
     * Displays an error notification message.
     * @param {string} message - The error message.
     * @return {void}
     */
    function showError(message) {
        showNotification('Error: ' + message, '#e74c3c');
    }

    /**
     * Displays a general notification message with a specified background color.
     * @param {string} message - The message to display.
     * @param {string} color - The background color for the notification.
     * @return {void}
     */
    function showNotification(message, color) {
        var notification = document.createElement('div');
        notification.style.position = 'fixed';
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.background = color;
        notification.style.color = 'white';
        notification.style.padding = '1rem';
        notification.style.borderRadius = '5px';
        notification.style.zIndex = '9999';
        notification.style.maxWidth = '300px';
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(function() {
            notification.remove();
        }, 3000);
    }

    /**
     * Generic error handler for `google.script.run` failures.
     * Hides loading indicator and shows an error message.
     * @param {Error|object|string} error - The error object or message.
     * @return {void}
     */
    function handleError(error) {
        hideLoading();
        showError(error.message || (typeof error === 'string' ? error : 'An unexpected error occurred'));
    }

</script>
</body>
</html>